window.PQ_DAW||(window.PQ_DAW={}),window.addEventListener("load",async function(){PQ_DAW.AUDIO.init(),PQ_DAW.PLAYER.init(),PQ_DAW.DISPLAY.init(),PQ_DAW.DOM.init();const e=[],t=document.getElementsByClassName("pq-daw-wrapper");for(const n of t){const s=new PQ_DAW.Daw({parent:n.parentNode,node:n});await s.loadResources(),e.push(s),n.remove()}window.DAWS=e}),PQ_DAW.AUDIO={init(){this.buffer={}},gainToDecibels(e){return 20*Math.log10(e)},decibelsToGain(e){return Math.pow(10,e/20)},getResource(e){return this.buffer[e]},hasResource(e){return e in this.buffer},saveResource(e,t){this.buffer[e]=t},async saveBlobResource(e,t,n){let s=new FileReader;const o=this;return new Promise((i,a)=>{s.onloadend=()=>{const n=s.result;e.getContext().decodeAudioData(n,e=>{o.saveResource(t,e),i(!0)},e=>{console.warn(e),a(!1)})},s.readAsArrayBuffer(n)})},checkAndLoadResources(e,t,n={}){let s=[];for(const o of t){if(this.hasResource(o))continue;s.push(this.loadResource(e,o,n))}return Promise.all(s)},loadResource(e,t,n={}){let o=n.path||"";o.length>0&&o.slice(0,-1)!="/"&&(o+="/");const i=n.extension||"ogg",a=o+t+"."+i,s=new XMLHttpRequest;s.open("GET",a,!0),s.responseType="arraybuffer";const r=this;return new Promise((n,o)=>{s.onload=function(){let s=this.response.byteLength<=24;if(s)return;e.getContext().decodeAudioData(this.response,function(e){r.saveResource(t,e),n(!0)},function(e){console.warn(e),o(!1)})},s.onerror=function(){o(!1)},s.send()})},play(e,t=0,n=0){if(e.getType()=="automation")return;const o=e.getContext();o.started&&o.state==="suspended"&&o.resume();const r=o.currentTime,i=r+n,u=t+e.getOffset(),c=i+e.getDuration()-t;let s;e.getType()=="audio"||e.getType()=="blob"?(s=o.createBufferSource(),s.buffer=this.getResource(e.getSource()),s.start(i,u,e.getDuration()),s.stop(c)):e.getType()=="oscillator"&&(s=o.createOscillator(),s.type="sine",s.frequency=440,s.start(i),s.stop(c));const a=e.getGain(),l=e.getFadeStart(),d=e.getFadeEnd();if(a.gain.cancelScheduledValues(r),l>0)if(t<=l){const n=i-t,s=e.getFadeValueAt(n-r,{min:1e-4,max:1});a.gain.setValueAtTime(s,n),a.gain.exponentialRampToValueAtTime(1,n+l)}else a.gain.exponentialRampToValueAtTime(1,i+.03);if(d>0){const t=c-d;let n=e.getFadeValueAt(t-r,{min:1e-4,max:1});t<=i&&(n=1),a.gain.setValueAtTime(n,t),a.gain.exponentialRampToValueAtTime(1e-4,c)}return s},stop(e){e.stop()},audioBufferToWaveBlobSimple(e){const[t,s]=[e.getChannelData(0),e.getChannelData(1)],n=new Float32Array(t.length+s.length);for(let e=0,o=0;e<t.length;e++,o+=2)n[o]=t[e],n[o+1]=s[e];const o=this.getWavBytes(n.buffer,{isFloat:!0,numChannels:2,sampleRate:48e3});return new Blob([o],{type:"audio/wav"})},getWavBytes(e,t){const o=t.isFloat?Float32Array:Uint16Array,i=e.byteLength/o.BYTES_PER_ELEMENT,n=this.getWavHeader(Object.assign({},t,{numFrames:i})),s=new Uint8Array(n.length+e.byteLength);return s.set(n,0),s.set(new Uint8Array(e),n.length),s},getWavHeader(e){const f=e.numFrames,u=e.numChannels||2,d=e.sampleRate||44100,r=e.isFloat?4:2,m=e.isFloat?3:1,a=u*r,h=d*a,c=f*a,l=new ArrayBuffer(44),i=new DataView(l);let t=0;function o(e){for(let n=0;n<e.length;n++)i.setUint8(t+n,e.charCodeAt(n));t+=e.length}function n(e){i.setUint32(t,e,!0),t+=4}function s(e){i.setUint16(t,e,!0),t+=2}return o("RIFF"),n(c+36),o("WAVE"),o("fmt "),n(16),s(m),s(u),n(d),n(h),s(a),s(r*8),o("data"),n(c),new Uint8Array(l)},async audioBufferToWaveBlob(e){return new Promise(function(t){var s=new Worker("/tutorials/js/buffer_to_wav.js");s.onmessage=function(e){var n=new Blob([e.data.buffer],{type:"audio/wav"});t(n)};let o=[];for(let t=0;t<e.numberOfChannels;t++)o.push(e.getChannelData(t));s.postMessage({pcmArrays:o,config:{sampleRate:e.sampleRate}})})},convertAudioBufferToType(e){return this.audioBufferToWav(e,"mp3")},audioBufferToWav(e,t="wav"){let r=e.numberOfChannels,l=e.length*r*2+44,d=new ArrayBuffer(l),h=new DataView(d),m=[],s,a,g=0,o=0;n(1179011410),n(l-8),n(1163280727),n(544501094),n(16),c(1),c(r),n(e.sampleRate),n(e.sampleRate*2*r),c(r*2),c(16),n(1635017060),n(l-o-4);for(s=0;s<e.numberOfChannels;s++)m.push(e.getChannelData(s));for(;o<l;){for(s=0;s<r;s++)a=Math.max(-1,Math.min(1,m[s][g])),a=(.5+a<0?a*32768:a*32767)|0,h.setInt16(o,a,!0),o+=2;g++}let i=lamejs.WavHeader.readHeader(new DataView(d)),u=new Int16Array(d,i.dataOffset,i.dataLen/2),p=[],f=[];for(let e=0;e<u.length;e+=2)p.push(u[e]),f.push(u[e+1]);var v=new Int16Array(p),b=new Int16Array(f);if(t==="MP3"){{if(i.channels===2)return wavToMp3Stereo(i.channels,i.sampleRate,v,b);if(i.channels===1)return wavToMp3(i.channels,i.sampleRate,u)}}else return new Blob([d],{type:"audio/wav"});function c(e){h.setUint16(o,e,!0),o+=2}function n(e){h.setUint32(o,e,!0),o+=4}},wavToMp3(e,t,n,s=null){for(var a,l,u,h,m,r=[],c=new lamejs.Mp3Encoder(e,t,128),d=n.length,i=1152,o=0;d>=i;o+=i)s?(h=n.subarray(o,o+i),m=s.subarray(o,o+i),a=c.encodeBuffer(h,m)):(u=n.subarray(o,o+i),a=c.encodeBuffer(u)),a.length>0&&r.push(a),d-=i;return l=c.flush(),l.length>0&&r.push(new Int8Array(l)),new Blob(r,{type:"audio/mp3"})},toLog(e,t,n){const s=(e-t)/(n-t);return t*Math.pow(n/t,s)},getSimpleBezierCurveTo(e,t,n,s){const o=Math.pow(1-e,2)*t.x+2*(1-e)*e*n.x+Math.pow(e,2)*s.x,i=Math.pow(1-e,2)*t.y+2*(1-e)*e*n.y+Math.pow(e,2)*s.y;return{x:o,y:i}},getBezierCurveTo(e,t,n,s,o){const i=Math.pow(1-e,3)*t.x+3*Math.pow(1-e,2)*e*n.x+3*(1-e)*e*e*s.x+Math.pow(e,3)*o.x,a=Math.pow(1-e,3)*t.y+3*Math.pow(1-e,2)*e*n.y+3*(1-e)*e*e*s.y+ +Math.pow(e,3)*o.y;return{x:i,y:a}},getVolumeAsGain(e=null){if(!e)return null;const s=e.fftSize,t=new Float32Array(s);e.getFloatTimeDomainData(t);let o=0,n=0;for(const s of t){const e=s-o;n+=e*e}n/=t.length;const i=Math.sqrt(n);return i}},PQ_DAW.Daw=class{constructor(e={}){this.setupContexts(e),this.defaults={tempo:120,duration:100,caption:""},this.node=this.setupHTML(e),this.setupTracks(e),this.time=0,this.soloActive=!1,this.startTime=0,this.startContextTime=0,this.loaded=!1,this.playing=!1,this.visualSeed=Math.random(),this.trackControlsSetup={};const t=this.node;this.controls=t.getElementsByClassName("daw-controls")[0],this.tracksContainer=t.getElementsByClassName("daw-tracks")[0];const s=t.getElementsByClassName("play-btn")[0];s.addEventListener("click",this.togglePlayPause.bind(this));const o=t.getElementsByClassName("stop-btn")[0];o.addEventListener("click",this.reset.bind(this));const i=t.getElementsByClassName("addtrack-btn")[0];i.addEventListener("click",()=>this.addTrack({redraw:!0}));const a=t.getElementsByClassName("removetrack-btn")[0];a.addEventListener("click",()=>this.removeTrack({redraw:!0}));const r=t.getElementsByClassName("download-btn")[0];r.addEventListener("click",()=>PQ_DAW.PLAYER.render(this));const n=e.parent;if(!n)return;e.node?n.insertBefore(t,e.node):n.appendChild(t)}setupHTML(e){const n=e.node||{dataset:{}},i=PQ_DAW.DOM;for(const e in this.defaults){if(e in n.dataset)continue;n.dataset[e]=this.defaults[e]}const t=document.createElement("figure");t.classList.add("pq-daw-wrapper","no-hover");for(const e in n.dataset)i.setProperty(t,e,n.dataset[e]);const a=n.dataset.caption;if(a!=""){const e=document.createElement("figcaption");e.classList.add("side-note"),t.appendChild(e);const n=document.createElement("span");n.innerHTML=a,e.appendChild(n)}const r=document.createElement("div");r.classList.add("daw-tracks"),t.appendChild(r);const s=document.createElement("div");s.classList.add("daw-controls"),t.appendChild(s);const c=["play","stop","addtrack","removetrack","download"];for(const e of c){const t=document.createElement("button");t.classList.add(e+"-btn","icon","icon-"+e),t.title=i.getTitleForShortcut("all",{name:e}),s.appendChild(t)}const l=["tempo","duration","numtracks","numeffects","feedback'"],o=document.createElement("div");o.classList.add("daw-metadata"),t.appendChild(o);for(const t of l){const e=document.createElement("span");e.classList.add(t+"-metadata"),o.appendChild(e)}return t}setupTracks(e){if(this.tracks=[],!this.hasMasterTrack(e.node)){const e=this.addTrack();e.setMaster(!0)}if(this.generateConfig(),!e.node)return;const t=e.node.getElementsByClassName("pq-daw-track");for(const e of t)this.addTrack({node:e});this.generateConfig()}addTrack(e={}){e.parent=this,e.num=this.tracks.length;const t=new PQ_DAW.Track(e);return this.tracks.push(t),e.redraw&&this.visualize(),t}removeTrack(e={}){let t=this.tracks.length-1;e.track&&(t=this.tracks.indexOf(e.track)),this.tracks[t].remove(),this.tracks.splice(t,1);for(let e=0;e<this.tracks.length;e++)this.tracks[e].setNum(e);e.redraw&&this.visualize()}recalculateAllVolumes(){this.checkSoloActive();for(const e of this.tracks)e.recalculateVolume()}checkSoloActive(){let e=!1;const t=PQ_DAW.DOM.getProperty;for(const n of this.tracks){if(t(n.node,"solo")!="true")continue;e=!0;break}this.soloActive=e}isSoloActive(){return this.soloActive}setupContexts(e){if(this.offline=e.offline||!1,this.isOffline()){const t=parseFloat(e.node.dataset.duration);console.log(t);const n=48e3;this.contextOffline=new OfflineAudioContext(2,n*t,n);return}const t=window.AudioContext||window.webkitAudioContext;this.context=new t,document.addEventListener("visibilitychange",e=>{document.visibilityState==="visible"?this.context.resume():this.context.suspend()})}updateMetadata(){const e=PQ_DAW.DOM;this.metadataContainer=this.node.getElementsByClassName("daw-metadata")[0];const t=this.metadataContainer.getElementsByClassName("tempo-metadata")[0];t.innerHTML="Tempo = "+e.getProperty(this.node,"tempo")+" BPM";const n=this.metadataContainer.getElementsByClassName("duration-metadata")[0];n.innerHTML="Duration = "+Math.round(parseFloat(e.getProperty(this.node,"duration"))*100)/100+" s";const s=this.metadataContainer.getElementsByClassName("numtracks-metadata")[0];s.innerHTML="# Tracks = "+(this.tracks.length-1);const o=this.metadataContainer.getElementsByClassName("numeffects-metadata")[0];o.innerHTML="# Effects = "+this.getAllEffects().length}readTimeFromContext(){this.startTime=this.time,this.startContextTime=this.getCurContextTime()}syncTimeWithContext(){const e=this.getCurContextTime()-this.startContextTime,t=this.startTime;this.setTime(t+e)}isOffline(){return this.offline}getContext(){return this.isOffline()?this.contextOffline:this.context}getCurContextTime(){return this.getContext().currentTime}async loadResources(){const e=this.getAllPartSources();await PQ_DAW.AUDIO.checkAndLoadResources(this,e),this.onLoadFinished()}onLoadFinished(){for(const e of this.getAllParts())e.calculateCorrectTimeParams();this.loaded=!0,this.listenForResize(),this.visualize(!0)}isLoaded(){return this.loaded}async requestRestart(){if(!this.isPlaying())return;await PQ_DAW.PLAYER.stop(this),await PQ_DAW.PLAYER.play(this)}async requestRestartForCallback(e){const t=this.isPlaying();t&&await PQ_DAW.PLAYER.stop(this),e(),t&&await PQ_DAW.PLAYER.play(this)}getPixelsPerSecond(){return this.config.pixelsPerSecond}getSecondsPerBeat(){return this.config.secondsPerBeat}getTotalDurationFromTracks(){let e=0;for(const t of this.tracks)e=Math.max(t.getDuration(),e);return e}getTimeInPixels(e){const t=Math.max(Math.min(e,this.config.duration),0);return this.getPixelsPerSecond()*t}getPixelsInTime(e){const t=Math.max(Math.min(e,this.config.trackWidth),0);return t/this.getPixelsPerSecond()}listenForResize(){const e=this;window.addEventListener("resize",t=>{setTimeout(e.visualize(!0),300)})}visualize(e=!1){if(this.isOffline())return;this.generateConfig(),PQ_DAW.DISPLAY.visualizeDaw(this,e)}getTracksContainer(){return this.node.getElementsByClassName("daw-tracks")[0]}getTrackWidth(){for(const e of this.tracks){if(!e.isVisible())continue;return e.getWidth()}}generateConfig(){const e=!this.getDuration()||this.getDuration()==this.defaults.duration;if(e){const e=this.getTotalDurationFromTracks();!isNaN(e)&&e>0&&this.setDuration(e)}this.config={tempo:parseInt(this.node.dataset.tempo),duration:parseInt(this.node.dataset.duration),trackHeight:150,trackWidth:this.getTrackWidth(),cursorWidth:2},this.config.pixelsPerSecond=this.config.trackWidth/this.config.duration,this.config.secondsPerBeat=this.config.tempo/60,this.config.colors=PQ_DAW.DISPLAY.generateColors(this.visualSeed,this.tracks.length)}async togglePlayPause(){this.playing=!this.playing,this.playing?await PQ_DAW.PLAYER.play(this):await PQ_DAW.PLAYER.stop(this,!1)}async reset(){this.playing=!1,await PQ_DAW.PLAYER.stop(this,!0)}hasMasterTrack(e){if(!e)return!1;const t=e.getElementsByClassName("pq-daw-track");for(const e of t)if(e.dataset.id=="master")return!0;return!1}findTrackWithID(e="master"){for(const t of this.tracks)if(t.getName().toLowerCase()==e.toLowerCase())return t;return null}getControlFromPathString(e){const t=e.split("/");if(t.length<=0)return null;const n=this.findTrackWithID(t[0]);return n?(t.splice(0,1),e=t.join("/"),n.getControlFromPathString(e)):null}setTime(e){const t=Math.max(Math.min(e,this.config.duration),0);this.time=t,this.visualize()}getTime(){return this.time}getTimeFromPercentage(e){return e*this.config.duration}advanceTime(e){this.setTime(this.time+e)}atEndTime(){return this.time>=this.config.duration}isPlaying(){return this.playing}setDuration(e){PQ_DAW.DOM.setProperty(this.node,"duration",e)}getDuration(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"duration"))}getConstantEffects(){let e=[];for(const t of this.tracks)e=e.concat(t.getConstantEffects());return e}getAllEffects(){let e=[];for(const t of this.tracks)e=e.concat(t.getEffects());return e}getAllParts(){let e=[];for(const t of this.tracks)e=e.concat(t.parts);return e}getAllPartSources(){let e=[];for(const t of this.tracks)e=e.concat(t.getAllPartSources());return e}getPartsWithStatus(e=!1){let t=[];for(const n of this.tracks)t=t.concat(n.getPartsWithStatus(e));return t}getPartsAtCurrentTime(e=!1){let t=[];for(const n of this.tracks)t=t.concat(n.getPartsAtTime(this.time,e));return t}},PQ_DAW.DOM={shortcuts:{all:{Space:{type:"custom",name:"play"},Escape:{type:"custom",name:"stop"}},tracks:{m:{type:"button",name:"mute"},v:{type:"slider",name:"volume",value:5},b:{type:"slider",name:"volume",value:-5},q:{type:"slider",name:"pan",value:-5},w:{type:"slider",name:"pan",value:5},s:{type:"button",name:"solo"},p:{type:"button",name:"phase"},r:{type:"button",name:"record"},C:{type:"effect",name:"compressor",shift:!0},E:{type:"effect",name:"equalizer",shift:!0},D:{type:"effect",name:"delay",shift:!0},X:{type:"effect",name:"distortion",shift:!0},N:{type:"effect",name:"noise",shift:!0},R:{type:"effect",name:"reverb",shift:!0}},parts:{f:{type:"fade",value:.1},g:{type:"fade",value:-.1}}},init(){this.focusNode=null,this.registerShortcuts()},isType(e,t){return e instanceof t},changeFocusTo(e){this.releaseFocus(this.focusNode),this.addFocus(e)},addFocus(e){this.focusNode=e,this.focusNode.node?this.focusNode.node.classList.add("pq-daw-dom-focus"):this.focusNode.classList.add("pq-daw-dom-focus")},releaseFocus(e){if(!e)return;this.focusNode.node?this.focusNode.node.classList.remove("pq-daw-dom-focus"):this.focusNode.classList.remove("pq-daw-dom-focus")},allPropertiesMatch(e,t){for(const n in t){if(!(n in e))return!1;if(e[n]!=t[n])return!1}return!0},getTitleForShortcut(e="tracks",t){const s=[],o=t.name||"";let i=!1;for(const[o,n]of Object.entries(this.shortcuts[e])){if(!this.allPropertiesMatch(n,t))continue;s.push(o.toUpperCase()),n.shift&&(i=!0)}if(s.length<=0)return"No shortcut";let n="Shortcut";return o!=""&&(n+=" ("+o+")"),n+=": ",i&&(n+="SHIFT+"),n+=s.join("/"),n},executeShortcut(e,t){t.type=="button"?this.fakeClickButton(e.node.getButton(t.name)):t.type=="slider"?this.fakeChangeSlider(e.node.getSlider(t.name),t.value):t.type=="effect"?e.node.addEffect({type:t.name}):t.type=="fade"?e.node.changeFade(t.value):t.type=="custom"&&(t.name=="play"?e.daw.togglePlayPause():t.name=="stop"&&e.daw.reset())},registerShortcuts(){document.addEventListener("keydown",e=>{const n=e.key,u=e.shiftKey,l=e.code,t=this.focusNode;if(!t)return!0;const o=this.isType(t,PQ_DAW.Track),i=this.isType(t,PQ_DAW.Part),h=this.isType(t,HTMLElement)&&t.hasAttribute("contenteditable");let a=null,r=null,d=null;o&&(a=t.daw,r=t),i&&(a=t.getDaw(),r=t.track,d=t);const c={daw:a,track:r,part:d,node:t};let s=!1;return(o||i)&&l in this.shortcuts.all&&(this.executeShortcut(c,this.shortcuts.all[l]),s=!0),o&&(n=="Delete"&&(u?t.removeLastEffect():t.queueRemoval()),n in this.shortcuts.tracks&&(this.executeShortcut(c,this.shortcuts.tracks[n]),s=!0)),i&&(n=="Delete"&&t.queueRemoval(),n in this.shortcuts.parts&&(this.executeShortcut(c,this.shortcuts.parts[n]),s=!0)),!s||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1)})},Slider:class{constructor(e,t,n){this.owner=e,this.nodes=t,this.params=n;const s={audioParams:[],unit:"percentage",callback:null,autoConnect:!1};for(const e in s){if(e in this.params)continue;this.params[e]=s[e]}Array.isArray(this.params.audioParams)||(this.params.audioParams=[this.params.audioParams]),this.createAutoConnection()}needsAutoConnection(){return this.params.unit||this.params.audioParams||this.params.callback||this.params.autoConnect}createAutoConnection(){if(!this.needsAutoConnection())return;PQ_DAW.DOM.connectSlider(this.nodes.slider,this,()=>{const t=this.nodes.slider.name;let e=this.getValueAsFloat();this.params.unit=="none"&&(e=this.getValue()),this.params.unit=="gain"&&(e=this.getValueAsGain()),PQ_DAW.DOM.setProperty(this.owner,t,e);for(const t of this.params.audioParams)t.setTargetAtTime(e,null,.03);this.params.callback&&this.params.callback(e),this.setDisplay(e)})}getValue(){return parseInt(this.nodes.slider.value)}getValueAsFloat(){return parseFloat(this.nodes.slider.value)}getValueAsGain(){return PQ_DAW.AUDIO.decibelsToGain(this.getValueAsFloat())}setDisplay(e,t=this.params.unit){let n="";t=="percentage"&&(n=Math.round(e*100)+"%"),t=="time"&&(n=e+"s"),t=="none"&&(n=e.toString()),t=="dimensionless"&&(n=(Math.round(e*100)/100).toString()),t=="decibels"&&(n=e+"dB"),t=="gain"&&(n=Math.round(PQ_DAW.AUDIO.gainToDecibels(e))+"dB"),t=="ratio"&&(n="1:"+e),t=="hertz"&&(e>=1e3?n=Math.round(e/1e3*10)/10+"kHz":n=e+"Hz"),this.nodes.display.innerHTML="("+n+")"}},Dragger:class{constructor(e){this.node=e,this.dragging=!1,this.lastDrag={x:0,y:0},this.callback=null,this.node.addEventListener("mousedown",this.onDragStart.bind(this),!0),document.addEventListener("mousemove",this.onDragProgress.bind(this),!0),document.addEventListener("mouseup",this.onDragEnd.bind(this),!0)}onDragStart(e){this.dragging=!0,this.lastDrag={x:e.clientX,y:e.clientY}}onDragProgress(e){if(!this.dragging)return;const t={x:e.clientX,y:e.clientY};let n={x:t.x-this.lastDrag.x,y:t.y-this.lastDrag.y};this.lastDrag=t,this.callback&&this.callback(n)}onDragEnd(e=null){if(!this.dragging)return;return this.dragging=!1,e&&(e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation()),!1}onMouseLeave(){this.onDragEnd(null)}},Drawable:class{constructor(e,t){this.part=e,this.canvas=t,this.drawing=!1,this.line=[],this.config={strokeStyle:"#00FF00",fillStyle:"#00FF00",lineWidth:4,radius:8,minDistBetweenPoints:10,minDistBetweenPointsVisual:40},t.addEventListener("mousedown",this.onDrawStart.bind(this),!0),t.addEventListener("mousemove",this.onDrawProgress.bind(this),!0),t.addEventListener("mouseup",this.onDrawEnd.bind(this),!0),t.addEventListener("mouseleave",this.onMouseLeave.bind(this),!0)}setDefaultLine(){this.reset()}getValueAt(e){if(this.line.length<2)return 1;this.sortPoints();let t=null,n=null;for(let s=1;s<this.line.length;s++)if(this.line[s-1].time<=e&&this.line[s].time>=e){t=this.line[s-1],n=this.line[s];break}t==null&&(t=this.line[0]),n==null&&(n=this.line[this.line.length-1]);const s=(e-t.time)/(n.time-t.time),o=t.value+s*(n.value-t.value);return o}reset(){this.line=[];const t=5;this.registerPoint({x:t,y:t},!0),this.registerPoint({x:this.canvas.width-t,y:t},!0),this.redraw()}visualize(e){this.config.strokeStyle=e,this.config.fillStyle=e,this.redraw()}redraw(){this.sortPoints(),this.drawPoints(),this.updateHTML()}updateHTML(){const e=this.part.node.parentElement.getElementsByClassName("pq-daw-track-part");for(const t of e){if(t.classList.contains("full-automation-part"))continue;t.remove()}for(const e of this.line)this.part.track.addPart({dataset:{source:Math.round(e.value*100)/100,start:Math.round(e.time*100)/100}})}sortPoints(){this.line.sort((e,t)=>e.time-t.time)}drawPoints(){if(this.line.length<2)return;const e=[];for(const t of this.line)e.push({x:this.getTimeInPixels(t.time),y:this.getValueInPixels(t.value)});const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)t.lineTo(e[n].x,e[n].y);t.strokeStyle=this.config.strokeStyle,t.lineWidth=this.config.lineWidth,t.stroke(),t.fillStyle=this.config.fillStyle,t.beginPath();let n=null;for(let s=0;s<e.length;s++){if(n){const t=Math.pow(e[s].x-n.x,2)+Math.pow(e[s].y-n.y,2);if(t<=Math.pow(this.config.minDistBetweenPointsVisual,2))continue}n=e[s],t.beginPath(),t.arc(e[s].x,e[s].y,this.config.radius,0,2*Math.PI,!1),t.fill()}}setLine(e){this.line=e}getPixelsInTime(e){return this.part.getDaw().getPixelsInTime(e)}getTimeInPixels(e){return this.part.getDaw().getTimeInPixels(e)}getValueInPixels(e){return(1-e)*this.canvas.height}getPixelsInValue(e){return 1-e/this.canvas.height}registerPoint(e,t=!1){let n=e.x,s=e.y;t||(n-=this.canvas.getBoundingClientRect().x,s-=this.canvas.getBoundingClientRect().y);let o=!0;for(let e=0;e<this.line.length;e++){const t=Math.abs(this.getTimeInPixels(this.line[e].time)-n);if(t>=this.config.minDistBetweenPoints)continue;this.line[e].value=this.getPixelsInValue(s),o=!1}o&&this.line.push({time:this.getPixelsInTime(n),value:this.getPixelsInValue(s)}),this.redraw()}preventDefaults(e){return!!e&&(e.stopPropagation(),e.preventDefault(),!1)}onDrawStart(e){return this.drawing=!0,this.registerPoint({x:e.clientX,y:e.clientY}),this.preventDefaults(e)}onDrawProgress(e){if(!this.drawing)return;return this.registerPoint({x:e.clientX,y:e.clientY}),this.preventDefaults(e)}onDrawEnd(e){return this.drawing=!1,this.preventDefaults(e)}onMouseLeave(){this.onDrawEnd(null)}},setProperty(e,t,n){e.dataset[t]=n},setProperties(e,t,n){for(let s=0;s<t.length;s++)e.dataset[t[s]]=n[s]},getProperty(e,t){return e.dataset[t]},toggleButton(e,t){e.dataset.toggled=="true"?(e.classList.remove("daw-btn-enabled"),e.dataset.toggled="false",e.innerHTML.toLowerCase()=="on"&&(e.innerHTML="Off")):(e.dataset.toggled="true",e.classList.add("daw-btn-enabled"),e.innerHTML.toLowerCase()=="off"&&(e.innerHTML="On")),e.dataset.onetime=="true"&&e.dataset.toggled=="true"&&this.toggleButton(e,t)},togglePlugin(e){e.isVisible()?e.setVisible(!1):e.setVisible(!0)},addDefaults(e,t){for(const n in t){if(n in e)continue;e[n]=t[n]}},createEffectControlContainer(e,t){const n=document.createElement("div");n.classList.add("effect-control-container"),e.appendChild(n);const s=document.createElement("div");s.classList.add("label-container"),n.appendChild(s);const o=document.createElement("label");o.innerHTML=t.text,o.for=t.name,s.appendChild(o);const i=document.createElement("span");return i.classList.add("value-display"),s.appendChild(i),n},createDropdown(e,t){const o=t.cont?t.cont:e,i={text:"Untitled",name:"untitled",callback:()=>{},keys:["No options"],values:[""]};this.addDefaults(t,i);const s=this.createEffectControlContainer(o,t);s.classList.add("effect-subsection");const n=document.createElement("select");n.name=t.name;for(let e=0;e<t.keys.length;e++){const o=t.keys[e],i=t.values[e],s=document.createElement("option");s.value=i,s.innerHTML=o,n.appendChild(s)}s.appendChild(n),n.addEventListener("change",()=>{const s=n[n.selectedIndex].value;this.setProperty(e,t.name,s),t.callback.call(this,n,e)}),this.fakeSelectDropdown(n)},createButton(e,t){const s=t.cont?t.cont:e,o={value:!1,text:"Untitled",name:"untitled",callback:()=>{}};this.addDefaults(t,o);const i=this.createEffectControlContainer(s,t),n=document.createElement("button");n.innerHTML="Off",i.appendChild(n),this.connectButton(n,e,(n,s)=>{this.setProperty(e,t.name,n.dataset.toggled),t.callback.call(this,n,s)}),t.value&&this.fakeClickButton(n)},createSlider(e,t={}){const o=t.cont?t.cont:e,i={min:0,max:100,step:1,value:0,text:"Untitled",name:"untitled",unit:"percentage"};this.addDefaults(t,i);const s=this.createEffectControlContainer(o,t),n=document.createElement("input");s.appendChild(n),n.type="range",n.min=t.min,n.max=t.max,n.step=t.step,n.value=t.value,n.name=t.name,n.dataset.unit=t.unit;const a={cont:s,label:s.getElementsByTagName("label"),display:s.getElementsByClassName("value-display")[0],slider:n};return new PQ_DAW.DOM.Slider(e,a,t)},createEditableText(e){const t=e.node;if(!t)return;const s=e.useCapture||!1,n=e.callback;t.addEventListener("click",()=>this.changeFocusTo(t),s),t.setAttribute("contentEditable",!0),n&&t.addEventListener("input",()=>{n(t)})},makeButtonSingleClick(e){e.dataset.onetime=!0},fakeSelectDropdown(e){var t=new Event("change",{bubbles:!0,cancelable:!1});e.dispatchEvent(t)},fakeSelectDropdownByIndex(e,t){const n=e.selectedIndex,s=n==t;if(s)return;e.selectedIndex=t,this.fakeSelectDropdown(e)},fakeClickButton(e){var t=new Event("click",{bubbles:!1,cancelable:!1});e.dispatchEvent(t)},fakeChangeSlider(e,t=0){e.value=parseFloat(e.value)+t;var n=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(n)},fakeSetSlider(e,t=0){const n=parseFloat(e.value);this.fakeChangeSlider(e,t-n)},connectSlider(e,t,n){e.addEventListener("input",s=>{n.call(this,e,t)}),this.fakeChangeSlider(e)},connectButton(e,t,n){e.dataset.toggled="false",e.addEventListener("click",s=>{this.toggleButton(e,t),n.call(this,e,t)})},connectPluginButton(e,t,n){e.addEventListener("click",s=>{this.toggleButton(e,t),this.togglePlugin(n)})}},PQ_DAW.Part=class{constructor(e){this.track=e.parent,this.defaults={source:"",type:"audio",start:0,end:"",duration:"",totalduration:"",offset:0,fadestart:.05,fadeend:.05},this.node=this.setupHTML(e),this.canvas=this.node.getElementsByTagName("canvas")[0],this.canvasDrawable=null,this.track.isType("automation")&&(e.automation?this.node.classList.add("full-automation-part"):this.convertToAutomationPoint()),this.sound=null,this.playing=!1,this.createAudioNodes(),this.createFadeVisualizations(),this.createDraggers(),this.makeCanvasDrawable(e),this.receiveDOMevents&&this.getCanvas().addEventListener("click",()=>PQ_DAW.DOM.changeFocusTo(this),!1)}convertToAutomationPoint(){this.dontVisualize=!0;for(const e of Object.keys(this.defaults)){if(e=="source"||e=="start")continue;this.node.removeAttribute("data-"+e)}this.node.style="display: none;",this.canvas.remove()}createAudioNodes(){if(!this.createNodes)return;const e=this.getDaw().getContext();this.gainNode=new GainNode(e)}createFadeVisualizations(){if(!this.allowFades)return;this.fadeStartNode=document.createElement("div"),this.fadeStartNode.classList.add("part-fade-visual"),this.fadeStartNode.left="0px",this.node.appendChild(this.fadeStartNode),this.fadeEndNode=document.createElement("div"),this.fadeEndNode.classList.add("part-fade-visual"),this.fadeEndNode.right="0px",this.node.appendChild(this.fadeEndNode)}createDraggers(){if(!this.allowDrag)return;const e=PQ_DAW.DOM;this.minWidth=15,this.edgeDragMargin=30,this.moveDragger=new e.Dragger(this.getCanvas()),this.moveDragger.callback=async e=>{if(Math.abs(e.x)==0)return;this.setLeftPos(this.getLeftPos()+e.x),await this.calculateCorrectTimeParamsFromDOM(!1),this.getDaw().visualize(!0)},this.startNode=document.createElement("div"),this.startNode.classList.add("part-edge-dragger"),this.startNode.style.width=this.edgeDragMargin+"px",this.node.appendChild(this.startNode),this.startDragger=new e.Dragger(this.startNode),this.startDragger.callback=async e=>{if(Math.abs(e.x)==0)return;let t=this.getLeftPos()+e.x,n=this.getRightPos(),s=this.getWidth()-e.x;if(s<this.minWidth)return;this.setLeftPos(t);const o=n-this.getLeftPos();this.setWidth(o),await this.calculateCorrectTimeParamsFromDOM(!0),this.getDaw().visualize(!0)},this.endNode=document.createElement("div"),this.endNode.classList.add("part-edge-dragger"),this.endNode.style.width=this.edgeDragMargin+"px",this.node.appendChild(this.endNode),this.endDragger=new e.Dragger(this.endNode),this.endDragger.callback=async e=>{if(Math.abs(e.x)==0)return;this.setWidth(this.getWidth()+e.x),await this.calculateCorrectTimeParamsFromDOM(!1),this.getDaw().visualize(!0)}}makeCanvasDrawable(e){if(!this.drawOnCanvas)return;this.canvasDrawable=new PQ_DAW.DOM.Drawable(this,this.getCanvas());const t=e.automation;t&&this.canvasDrawable.setLine(e.automation)}setupHTML(e){const n=e.node||{dataset:{}},o=PQ_DAW.DOM;for(const e in this.defaults){if(e in n.dataset)continue;n.dataset[e]=this.defaults[e]}const t=document.createElement("div");t.classList.add("pq-daw-track-part");for(const e in n.dataset)o.setProperty(t,e,n.dataset[e]);this.changeSetupBasedOnPartType(t,e);const s=document.createElement("canvas");s.width=0,s.height=0,t.appendChild(s);const i=e.parent.getTrackContentContainer();return i.appendChild(t),t}changeSetupBasedOnPartType(e){this.fullLength=!1,this.allowDrag=!0,this.allowFades=!0,this.drawOnCanvas=!1,this.createNodes=!0,this.allowPlaying=!0,this.dontVisualize=!1,this.receiveDOMevents=!0,this.track.isType("automation")&&(PQ_DAW.DOM.setProperty(e,"type","automation"),this.fullLength=!0,this.allowDrag=!1,this.allowFades=!1,this.drawOnCanvas=!0,this.createNodes=!1,this.allowPlaying=!1,this.receiveDOMevents=!1)}getContext(){return this.getDaw().getContext()}getDaw(){return this.track.daw}setWidth(e){e=Math.min(Math.max(e,this.minWidth),this.track.getWidth()-this.getLeftPos()),this.node.style.width=e+"px",this.endNode&&(this.endNode.style.right="0px")}getWidth(){return this.node.getBoundingClientRect().width}setLeftPos(e){let t=this.track.getWidth()-this.getWidth();t<=0&&(t=1/0),e=Math.min(Math.max(e,0),t),this.node.style.left=e+"px",this.startNode&&(this.startNode.style.left="0px"),this.endNode&&(this.endNode.style.right="0px")}getLeftPos(){return this.node.getBoundingClientRect().left-this.node.parentNode.getBoundingClientRect().left}getRightPos(){return this.node.getBoundingClientRect().right-this.node.parentNode.getBoundingClientRect().left}async calculateCorrectTimeParamsFromDOM(e=!1){const t=PQ_DAW.DOM.setProperty,s=this.getStartTime();let n=PQ_DAW.DISPLAY.pixelsToTime(this.getDaw(),this.getLeftPos(),!1),o=PQ_DAW.DISPLAY.pixelsToTime(this.getDaw(),this.getWidth(),!1);if(e){const e=this.getOffset()+(n-s);t(this.node,"offset",e)}t(this.node,"start",n),t(this.node,"duration",o),t(this.node,"end","NoEndTimeSpecified"),await this.getDaw().requestRestartForCallback(()=>{this.calculateCorrectTimeParams()})}calculateCorrectTimeParams(){if(this.dontVisualize)return;const o=this.node,c=PQ_DAW.DOM.getProperty,i=PQ_DAW.DOM.setProperty,r=.25;let e=this.getDuration(),t=this.getStartTime(),n=this.getEndTime(),a=Math.max(this.getOffset(),0),s=parseFloat(c(o,"totalduration"));isNaN(s)&&this.hasLoadableSource()&&(s=PQ_DAW.AUDIO.getResource(this.getSource()).duration);const l=[!isNaN(t),!isNaN(n),!isNaN(e)],d=l.filter(Boolean).length;d<=1&&(e=s);const u=!isNaN(t)&&!isNaN(e),h=!isNaN(n)&&!isNaN(t),m=!isNaN(t)&&!isNaN(n);m?e=n-t:u?n=t+e:h&&(t=n-e),t=Math.max(t,0),n=Math.min(n,this.getDaw().getDuration()),e=n-t;let f=e+a;f>s&&(e=Math.max(s-a,r),n=t+e),this.hasLoadableSource()||(s=e),this.fullLength&&(t=0,n=this.getDaw().getDuration(),a=0,e=n-t,s=e),i(o,"start",t),i(o,"end",n),i(o,"offset",a),i(o,"duration",e),i(o,"totalduration",s)}getCanvas(){return this.canvas}getOutputNode(){return this.gainNode}getGain(){return this.gainNode}isPlaying(){return this.playing}setPlaying(e,t=0,n=0){if(this.playing=e,!this.allowPlaying)return;if(this.playing)this.sound=PQ_DAW.AUDIO.play(this,this.getTimeDiff(t),n),this.sound.connect(this.gainNode);else{if(!this.sound)return;PQ_DAW.AUDIO.stop(this.sound),this.sound.disconnect(this.gainNode),this.sound=null}}getTimeDiff(e=0){return e-this.getStartTime()}isActiveAtTime(e=0){return this.getStartTime()<=e&&this.getEndTime()>=e}getSource(){return PQ_DAW.DOM.getProperty(this.node,"source")}getOffset(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"offset"))}getStartTime(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"start"))}getEndTime(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"end"))}getDuration(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"duration"))}getFadeStart(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"fadestart"))}getFadeEnd(){return parseFloat(PQ_DAW.DOM.getProperty(this.node,"fadeend"))}changeFade(e=.025){const t=Math.max(this.getFadeStart()+e,0),n=Math.max(this.getFadeEnd()+e,0);PQ_DAW.DOM.setProperty(this.node,"fadestart",Math.round(t*100)/100),PQ_DAW.DOM.setProperty(this.node,"fadeend",Math.round(n*100)/100),PQ_DAW.DISPLAY.visualizePart(this.getDaw(),this.track,this)}getFadeValueAt(e=0,t){let n=t.min,i=t.max,s=0,a=this.getFadeStart(),o=!1;if(e<=this.getFadeStart()&&(o=!0),e>=this.getDuration()-this.getFadeEnd()&&(o=!0,n=t.max,i=t.min,s=this.getDuration()-this.getFadeEnd(),a=this.getDuration()),!o)return t.max;const r=(e-s)/(a-s);return n*Math.pow(i/n,r)}getType(){return PQ_DAW.DOM.getProperty(this.node,"type")}hasLoadableSource(){return!!this.createAudioNodes&&this.getType()=="audio"}setDataFrom(e={}){for(const t in e)PQ_DAW.DOM.setProperty(this.node,t,e[t])}remove(){this.node.remove()}queueRemoval(){this.track.removePart(this)}},PQ_DAW.PLAYER={init(){this.daws=[],this.offlineAutomateMargin=5,this.update()},async render(e,t=!1){const n=this.playOffline(e),o=this.automateOffline(n),s=await n.getContext().startRendering();if(clearInterval(o),t){const t=e.getContext().createBufferSource();t.buffer=s,t.connect(e.getContext().destination),t.start()}const i=PQ_DAW.AUDIO.audioBufferToWaveBlobSimple(s),a=URL.createObjectURL(i);this.downloadRender(a)},downloadRender(e){var t=document.createElement("a");t.style.display="none",t.href=e,t.download="Mixdown.wav",document.body.appendChild(t),t.click()},automateOffline(e){return setInterval(()=>{e.setTime(e.getContext().currentTime),this.readFromAutomation(e)},this.offlineAutomateMargin)},playOffline(e){const t=new PQ_DAW.Daw({node:e.node,offline:!0}),n=t.getAllParts();for(const e of n)e.setPlaying(!0,0,e.getStartTime());return t},update(){if(window.requestAnimationFrame(this.update.bind(this)),this.daws.length<=0)return;for(const e of this.daws)this.updateDAW(e)},updateDAW(e){e.syncTimeWithContext();const t=e.getPartsAtCurrentTime(!1);for(const n of t)n.setPlaying(!0,e.getTime());this.readFromAutomation(e),e.visualize(!1),e.atEndTime()&&e.reset()},async play(e){e.readTimeFromContext();for(const t of e.tracks){if(!t.isRecordEnabled())continue;await t.startRecording(e.getTime())}e.visualize(!0);const t=e.getPartsAtCurrentTime(null);for(const n of t)n.setPlaying(!0,e.getTime());const n=e.getConstantEffects();for(const e of n)e.setPlaying(!0);this.daws.push(e)},async stop(e,t=!1){this.daws.splice(this.daws.indexOf(e),1);const n=e.getPartsWithStatus(!0);for(const e of n)e.setPlaying(!1);const s=e.getConstantEffects();for(const e of s)e.setPlaying(!1);for(const t of e.tracks){if(!t.isRecordEnabled()||!t.hasActiveRecording())continue;await t.stopRecording(e.getTime())}t&&(e.setTime(0),e.visualize(!1))},readFromAutomation(e){const n=e.getTime(),t=PQ_DAW.DOM;for(const o of e.tracks){if(!o.isType("automation"))continue;if(o.isBypassed())continue;const i=o.getAutomationValueAt(n);if(i==null){console.error("No valid automation value at time "+n+" from track "+o.getName());continue}const s=e.getControlFromPathString(o.getOutPath());if(!s){console.error("Can't read automation from path "+o.getOutPath()+" at track "+o.getName());continue}const a=s.tagName.toLowerCase();if(a=="input"){let e=parseFloat(s.min)+i*(parseFloat(s.max)-parseFloat(s.min));t.fakeSetSlider(s,e)}else if(a=="select"){const e=s.length;let n=Math.min(Math.max(i,0),.99),o=Math.floor(e*n);t.fakeSelectDropdownByIndex(s,o)}else if(a=="button"){let e=i>=.5?"true":"false";s.dataset.toggled!=e&&t.fakeClickButton(s)}}}},PQ_DAW.Track=class{constructor(e){this.daw=e.parent,this.num=e.num,this.defaults={id:"",type:"regular",mute:!1,solo:!1,mono:!1,phase:!1,record:!1,out:"master",effects:"",display:!0,pan:0,volume:0,master:!1,show:"",hide:"",bypass:!1},this.node=this.setupHTML(e);const t=PQ_DAW.DOM,n=this.node;this.volumeDisplay=n.getElementsByClassName("volume-display")[0],this.volumeRect=n.getElementsByClassName("volume-display-rect")[0],this.trackControls=n.getElementsByClassName("track-controls")[0],this.trackContent=n.getElementsByClassName("track-content")[0],this.timeGridCanvas=this.trackContent.getElementsByClassName("time-grid")[0].getElementsByTagName("canvas")[0],this.cursor=this.trackContent.getElementsByClassName("time-cursor")[0],this.typeLabel=this.trackContent.getElementsByClassName("track-type-label")[0],this.typeLabel.innerHTML=this.getType().toUpperCase(),this.trackContent.addEventListener("mouseup",this.placeTimeCursorAtClick.bind(this),!1),this.node.addEventListener("click",()=>t.changeFocusTo(this),!0),this.trackName=this.node.getElementsByClassName("track-name")[0],this.allowEditingName&&t.createEditableText({node:this.trackName,callback:this.setNameFromDOM.bind(this)}),this.outName=this.node.getElementsByClassName("out-name")[0],this.allowEditingOut&&t.createEditableText({node:this.outName,callback:this.setOutFromDOM.bind(this)}),this.containers={controls:this.trackControls,volume:this.volumeDisplay,effects:this.effectLabelsContainer,name:this.trackName},this.init(),this.setupParts(e);const s=["volume","pan"];this.sliders={};for(const e of s){const o=n.getElementsByClassName(e)[0];if(!o)continue;const i=parseFloat(t.getProperty(this.node,e));this.sliders[e]=o,t.connectSlider(o,this,(t,n)=>{n.changeSlider(e)}),t.fakeSetSlider(o,i)}const o=["mute","solo","mono","phase","record","bypass","reset"];this.buttons={};for(const e of o){const s=n.getElementsByClassName(e)[0];if(!s)continue;this.buttons[e]=s;const i=this.daw;t.connectButton(s,this,(n,s)=>{t.setProperty(s.node,e,n.dataset.toggled),s.recalculateVolume(),e=="solo"&&i.recalculateAllVolumes()});const a=t.getProperty(this.node,e);a=="true"&&t.fakeClickButton(s),e=="reset"&&(t.makeButtonSingleClick(s),s.addEventListener("click",e=>{this.reset()}))}this.showHideControls(),this.setVisible(t.getProperty(this.node,"visible")!="false")}changeSetupBasedOnTrackType(e){this.useOutAsBus=!0,this.showOut=!1,this.allowEditingOut=!1,this.createNodes=!0,this.createEffects=!0,this.allowEditingName=!1,this.addBypassControls=!1;const t=PQ_DAW.DOM.getProperty(e,"type");t=="automation"&&(this.useOutAsBus=!1,this.createNodes=!1,this.createEffects=!1,this.showOut=!0,this.allowEditingOut=!0,this.addBypassControls=!0)}setupHTML(e){const i=e.node||{dataset:{}},u=PQ_DAW.DOM;for(const e in this.defaults){if(e in i.dataset)continue;i.dataset[e]=this.defaults[e]}if(e.node)this.daw.trackControlsSetup=e.node.dataset;else for(const e in this.daw.trackControlsSetup)i.dataset[e]=this.daw.trackControlsSetup[e];const t=document.createElement("div");t.classList.add("pq-daw-track");for(const e in i.dataset)u.setProperty(t,e,i.dataset[e]);this.changeSetupBasedOnTrackType(t);const o=document.createElement("div");o.classList.add("track-controls"),t.appendChild(o);const l=document.createElement("div");l.classList.add("track-metadata"),o.appendChild(l);const g=document.createElement("span");g.classList.add("track-name"),g.innerHTML=u.getProperty(t,"id"),l.appendChild(g);const m=document.createElement("span");m.classList.add("out-name"),m.innerHTML=u.getProperty(t,"out"),l.appendChild(m),this.showOut||(m.style.display="none");const j=document.createElement("div");j.classList.add("track-buttons");const y={mute:"M",solo:"S",phase:"P",mono:"1/2",record:"R",bypass:"Bypass",reset:"Reset"};for(const e in y){if(e=="mono")continue;if(!this.createNodes&&(e=="mute"||e=="solo"||e=="phase"||e=="mono"||e=="record"))continue;if(!this.addBypassControls&&(e=="bypass"||e=="reset"))continue;const t=document.createElement("button");t.classList.add(e),t.name=e,t.title=u.getTitleForShortcut("tracks",{name:e}),t.innerHTML=y[e],j.appendChild(t)}o.appendChild(j);const d=document.createElement("div");d.classList.add("track-core-controls"),o.appendChild(d);const n=document.createElement("input");n.type="range",n.classList.add("pan"),n.name="pan",n.min=-100,n.max=100,n.step=1,n.title=PQ_DAW.DOM.getTitleForShortcut("tracks",{name:"pan"}),d.appendChild(n),this.createNodes||(d.style.display="none");const h=document.createElement("div");h.classList.add("track-effects"),o.appendChild(h),this.effectLabelsContainer=h,this.createNodes||(h.style.display="none");const c=document.createElement("div");c.classList.add("volume-display"),t.appendChild(c);const f=document.createElement("div");f.classList.add("volume-display-container"),c.appendChild(f);const O=document.createElement("div");O.classList.add("volume-display-rect"),f.appendChild(O);const s=document.createElement("input");s.type="range",s.classList.add("volume"),s.name="volume",s.min=-100,s.max=0,s.title=PQ_DAW.DOM.getTitleForShortcut("tracks",{name:"volume"}),f.appendChild(s),this.createNodes||(c.innerHTML="");const r=document.createElement("div");r.classList.add("track-content"),t.appendChild(r);const v=document.createElement("div");v.classList.add("time-grid"),r.appendChild(v);const b=document.createElement("canvas");b.width=0,b.height=0,v.appendChild(b);const _=document.createElement("div");_.classList.add("time-cursor"),r.appendChild(_);const w=document.createElement("div");w.classList.add("track-type-label"),r.appendChild(w);let p=document.createElement("div");p.classList.add("pq-daw-track-effects");let a=i.nextElementSibling;a&&!a.classList.contains("pq-daw-track-effects")&&(a=null),a&&(p=a.cloneNode(!0)),this.effectWindowsContainer=p;const x=e.parent.getTracksContainer();return x.appendChild(t),x.appendChild(p),t}setupParts(e){if(this.parts=[],!e.node)return;const t=e.node.getElementsByClassName("pq-daw-track-part");if(this.isType("automation")){const e=[];for(const n of t){if(n.classList.contains("full-automation-part"))continue;e.push({time:parseFloat(n.dataset.start),value:parseFloat(n.dataset.source)})}this.addPart({automation:e})}for(const e of t)this.addPart({node:e})}addPart(e){e.parent=this;const t=new PQ_DAW.Part(e);return e.dataset&&t.setDataFrom(e.dataset),e.recalculate&&t.calculateCorrectTimeParams(),this.parts.push(t),t.getOutputNode()&&t.getOutputNode().connect(this.analyserNode),e.redraw&&PQ_DAW.DISPLAY.visualizeTrack(this.daw,this,!0),t}showHideControls(){const n=PQ_DAW.DOM;let t=n.getProperty(this.node,"show").split(",");const s=n.getProperty(this.node,"hide").split(","),o=t.length<=0||t[0]=="",e={};for(const t in this.buttons)e[t]=this.buttons[t];for(const t in this.sliders)e[t]=this.sliders[t];for(const t in this.containers)e[t]=this.containers[t];o&&(t=Object.keys(e));for(const n of Object.keys(e)){if(t.includes(n)&&!s.includes(n))continue;e[n].style.display="none"}}init(){this.initTrackName(),this.initAudioNodes(),this.initBus(),this.initEffects()}initTrackName(){if(this.getName())return;const e=this.generateName();this.setName(e)}setNameFromDOM(e){const t=e.innerHTML;PQ_DAW.DOM.setProperty(this.node,"id",t)}getName(){return PQ_DAW.DOM.getProperty(this.node,"id")}setName(e){PQ_DAW.DOM.setProperty(this.node,"id",e),this.trackName.innerHTML=e}getControlFromPathString(e){const n=e.split("/");if(n.length<=1)return null;const t=[],s=n[0];if(s=="control"&&(t.push(this.trackControls.getElementsByClassName("track-metadata")[0]),t.push(this.trackControls.getElementsByClassName("track-buttons")[0]),t.push(this.trackControls.getElementsByClassName("track-core-controls")[0]),t.push(this.volumeDisplay)),t.length<=0){const e=this.effectWindowsContainer.getElementsByClassName(s)[0];e&&t.push(e)}const o=n[1];return this.getControlWithName(t,o)}getControlWithName(e,t){for(const s of e){let n=s.querySelectorAll("*[name='"+t+"']");if(n.length<=0)continue;return n[0]}return null}isBypassed(){return PQ_DAW.DOM.getProperty(this.node,"bypass")=="true"}getAutomationValueAt(e){return this.parts[0].canvasDrawable.getValueAt(e)}getType(){return PQ_DAW.DOM.getProperty(this.node,"type")}isType(e){return this.getType()==e}initAudioNodes(){if(!this.createNodes)return;this.inputNode&&this.inputNode.disconnect(),this.outputNode&&this.outputNode.disconnect();const e=this.daw.getContext();this.analyserNode=new AnalyserNode(e),this.analyserNode.fftSize=1024,this.analyserNode.maxDecibels=0,this.analyserNode.minDecibels=-128,this.inputNode=this.analyserNode,this.effectInputNode=this.inputNode,this.volumeNode=new GainNode(e),this.inputNode.connect(this.volumeNode),this.effectOutputNode=this.volumeNode,this.panNode=new StereoPannerNode(e),this.volumeNode.connect(this.panNode),this.outputNode=this.panNode}initEffects(){if(this.effects=[],!this.createEffects)return;if(this.daw.isOffline()){const e=this.effectWindowsContainer.getElementsByClassName("effect");for(const t of e)this.addEffect({type:t.dataset.type,existingHTML:t});return}const e=PQ_DAW.DOM.getProperty(this.node,"effects").split(",");for(const n of e){const t=n.trim();if(t=="")continue;this.addEffect({type:t})}}initBus(){if(!this.useOutAsBus)return;const t=this.daw.getContext(),n=this.getOutPath(),e=this.daw.findTrackWithID(n);e?this.outputNode.connect(e.getInputNode()):this.outputNode.connect(t.destination)}getSlider(e){return e in this.sliders?this.sliders[e]:(console.error("Slider with key "+e+" doesn't exist on track."),null)}getButton(e){return e in this.buttons?this.buttons[e]:(console.error("Button with key "+e+" doesn't exist on track."),null)}getInputNode(){return this.inputNode}getOutputNode(){return this.outputNode}getOutPath(){return PQ_DAW.DOM.getProperty(this.node,"out")}setOutFromDOM(e){const t=e.innerHTML;PQ_DAW.DOM.setProperty(this.node,"out",t)}generateName(){return"Track #"+this.num}isMaster(){return PQ_DAW.DOM.getProperty(this.node,"master")=="true"}setMaster(){PQ_DAW.DOM.setProperty(this.node,"master",!0),this.setName("master"),this.setVisible(!1)}setNum(e){this.num=e}getNum(){return this.num}getTrackContentContainer(){return this.trackContent}getWidth(){return this.trackContent.offsetWidth}getDuration(){if(this.isType("automation")||this.isType("bus"))return 0;let e=0;for(const t of this.parts)e=Math.max(e,t.getEndTime());return e}async placeTimeCursorAtClick(e){const t=e.clientX-this.trackContent.getBoundingClientRect().left,n=t/this.getWidth();await this.daw.requestRestartForCallback(()=>{this.daw.setTime(this.daw.getTimeFromPercentage(n))})}recalculateVolume(){if(!this.volumeNode)return;const t=parseFloat(this.sliders.volume.value);PQ_DAW.DOM.setProperty(this.node,"volume",t);const s=(t+100)/100;let e=s,n=this.daw.isSoloActive();n&&!this.isSolo()&&(e=0),!n&&this.isMuted()&&(e=0),this.isPhaseInverted()&&(e*=-1);const o=this.daw.getContext().currentTime,i=.01;this.volumeNode.gain.setTargetAtTime(e,o,i)}isMuted(){return PQ_DAW.DOM.getProperty(this.node,"mute")=="true"}isSolo(){return!!this.isMaster()||PQ_DAW.DOM.getProperty(this.node,"solo")=="true"}isPhaseInverted(){return PQ_DAW.DOM.getProperty(this.node,"phase")=="true"}isVisible(){return PQ_DAW.DOM.getProperty(this.node,"visible")=="true"}setVisible(e){PQ_DAW.DOM.setProperty(this.node,"visible",e),e?this.node.style.display="flex":this.node.style.display="none"}isRecordEnabled(){return PQ_DAW.DOM.getProperty(this.node,"record")=="true"}hasActiveRecording(){return this.recorder.getState()=="recording"}async startRecording(e=0){this.recorder=new PQ_DAW.Recorder,await this.recorder.start(e)}async stopRecording(e=0){this.recorder.stop(e),await this.recorder.saveInBuffer(this.daw);const t=this.addPart(this.recorder.getPartParams())}changeSlider(e){e=="volume"?this.recalculateVolume():e=="pan"&&this.changePanning()}changePanning(){if(!this.panNode)return;const e=parseFloat(this.sliders.pan.value);PQ_DAW.DOM.setProperty(this.node,"pan",e);const t=e/100,n=this.daw.getContext().currentTime,s=.01;this.panNode.pan.setTargetAtTime(t,n,s)}getAnalyser(){return this.analyserNode}getPartsWithStatus(e=!1){const t=[];for(const n of this.parts){if(n.isPlaying()!=e)continue;t.push(n)}return t}getPartsAtTime(e=0,t=!1){const n=[];for(const s of this.parts){if(!s.isActiveAtTime(e))continue;if(t!=null&&s.isPlaying()!=t)continue;n.push(s)}return n}getAllPartSources(){const e=[];for(const t of this.parts){if(!t.hasLoadableSource())continue;e.push(t.getSource())}return e}getConstantEffects(){const e=[];for(const t of this.effects){if(!t.isConstant())continue;e.push(t)}return e}removePart(e){const t=this.parts.indexOf(e);if(t<0){console.error("Tried to remove non-existing part!");return}this.parts[t].remove(),this.parts.splice(t,1)}removeAllParts(e=!1){if(!this.parts)return;if(e){const e=this.node.getElementsByClassName("pq-daw-track-part");for(const t of e)t.remove()}for(let e=this.parts.length-1;e>=0;e--)this.removePart(this.parts[e])}injectEffectIntoAudioChain(e,t=-1){t==-1&&(t=this.effects.length);let n=this.effectInputNode,s=this.effectOutputNode;t>0&&(n=this.effects[t-1].getOutputNode()),t<this.effects.length-2&&(s=this.effects[t].getInputNode()),n.disconnect(s),n.connect(e.getInputNode()),e.getOutputNode().connect(s)}extractEffectFromAudioChain(e){const t=this.effects.indexOf(e),o=e.getInputNode(),i=e.getOutputNode(),n=t==0?this.effectInputNode:this.effects[t-1].getOutputNode(),s=t<this.effects.length-1?this.effects[t+1].getInputNode():this.effectOutputNode;n.disconnect(o),i.disconnect(s),n.connect(s)}addEffect(e={}){if(!this.createEffects)return;if(!e.type){console.error("Can't add effect without type");return}const n=e.type,t=document.createElement("button");t.classList.add("effect",n,"icon","icon-"+n),t.name="effect-"+n,t.title=PQ_DAW.DOM.getTitleForShortcut("tracks",{name:n}),t.dataset.name=n,this.effectLabelsContainer.appendChild(t),e.button=t,e.parent=this;const s=new PQ_DAW.Plugin(e);return this.injectEffectIntoAudioChain(s),this.effects.push(s),PQ_DAW.DOM.connectPluginButton(t,this,s),s}removeEffect(e){const t=this.effects.indexOf(e);if(t==-1)return;this.extractEffectFromAudioChain(e),e.remove(),this.effects.splice(t,1)}removeLastEffect(){if(this.effects.length<=0)return;this.removeEffect(this.effects[this.effects.length-1])}getEffects(){return this.effects}queueRemoval(){this.daw.removeTrack({track:this,redraw:!0})}reset(){this.isType("automation")&&this.parts[0].canvasDrawable.reset()}remove(){this.node.remove()}},PQ_DAW.DISPLAY={init(){},Color:class{constructor(e,t,n){this.h=e,this.s=t,this.l=n}toString(){return"hsl("+this.h+", "+this.s+"%, "+this.l+"%)"}lighten(e=0){const t=Math.max(Math.min(this.l+e,100),0);return new PQ_DAW.DISPLAY.Color(this.h,this.s,t)}},generateColors(e,t){const n=[],s=e*360,o=360/t;for(let e=0;e<t;e++){const i=s+e*o;n.push(new PQ_DAW.DISPLAY.Color(i,50,50))}return n},visualizeDaw(e,t=!1){if(!e.isLoaded()){console.error("Can't visualize DAW that's not fully loaded");return}const n=e.getTime();for(const n of e.tracks)PQ_DAW.DISPLAY.visualizeTrack(e,n,t);e.updateMetadata()},visualizeTrack(e,t,n=!0){if(!t.isVisible())return;t.node.style.height=e.config.trackHeight+"px",this.visualizeTimeGrid(e,t),this.visualizeCursor(e,t),this.visualizeVolume(e,t);const s=this.getColorForTrack(t);t.trackControls.style.backgroundColor=s.lighten(-25).toString(),t.trackContent.style.backgroundColor=s.lighten(25).toString(),t.volumeDisplay.style.backgroundColor=s.lighten(-35).toString();for(const s of t.parts)this.positionPart(e,t,s),n&&this.visualizePart(e,t,s)},visualizeTimeGrid(e,t){const n=t.timeGridCanvas;n.width=e.config.trackWidth,n.height=e.config.trackHeight;const c=10,i=.15,a=n.getContext("2d"),d=.25,s=e.getPixelsPerSecond()*e.getSecondsPerBeat(),l=Math.ceil(n.width/s);let o=4;const r=s/o;r<=c&&(o=1);for(let e=0;e<l;e++)for(let t=0;t<o;t++){const c=e*s+t*r,l=t==0?2:1;a.fillStyle=t==0?"rgba(0,0,0,"+i+")":"rgba(100,100,100,"+i+")",a.fillRect(c,0,l,n.height)}},visualizeCursor(e,t){t.cursor.style.width=e.config.cursorWidth+"px",t.cursor.style.left=e.getPixelsPerSecond()*e.getTime()-.5*e.config.cursorWidth+"px"},visualizeVolume(e,t){let n=PQ_DAW.AUDIO.getVolumeAsGain(t.getAnalyser());if(n==null)return;const r=48;n=1- -PQ_DAW.AUDIO.gainToDecibels(n)/r,n=Math.round(n*100);const a=parseInt(t.volumeRect.style.height.replace("%","")||100);let s=a+(n-a)*.1;s=Math.max(Math.min(s,100),0);const c=100*(1-s/100),l=new PQ_DAW.DISPLAY.Color(c,50,50),o=e.config.trackHeight,i=t.getSlider("volume");i.style.width=o-5+"px",i.style.top=.5*o-10+"px",i.style.left=-(.5*o-8)+"px",t.volumeRect.style.height=s+"%",t.volumeRect.style.backgroundColor=l.toString()},positionPart(e,t,n){const s=this.timeToPixels(e,n.getStartTime(),!1);n.setLeftPos(s)},getColorForTrack(e){const t=e.daw.config;return t?t.colors[e.getNum()]:"#000000"},visualizePart(e,t,n){if(n.dontVisualize)return;const o=n.getType(),a=2*window.getComputedStyle(n.node)["margin-top"].slice(0,-2),s=n.getCanvas();s.height=e.config.trackHeight-a,s.width=this.timeToPixels(e,n.getDuration(),!1);const i=this.getColorForTrack(t);n.node.style.backgroundColor="rgba(255,255,255,0.3)",n.setWidth(s.width);const r=s.getContext("2d");r.clearRect(0,0,s.width,s.height),o=="audio"||o=="blob"?this.visualizeFullWaveform(e,n,i):o=="automation"?this.visualizeAutomation(e,n,i):o=="oscillator"&&this.visualizeOscillator(e,n,i),this.visualizePartFades(n,e.config.pixelsPerSecond)},visualizePartFades(e,t){const n=e.getFadeStart()*t,s=e.getFadeEnd()*t;this.visualizeFadeLine(e.getCanvas(),n,"start"),this.visualizeFadeLine(e.getCanvas(),s,"end")},visualizeFadeLine(e,t,n="start"){const s=e.getContext("2d");s.save(),s.beginPath();const i=n=="start"?0:e.width;s.moveTo(i,e.height);const o=16,a=1/o;for(let i=0;i<=o;i++){const c=i*a;let r=c*t;n=="end"&&(r=e.width-r);const l=Math.pow(c,.35),d=(1-l)*e.height;s.lineTo(r,d)}s.strokeStyle="rgba(0,0,0,0.5)",s.lineWidth=3,s.stroke(),s.restore()},timeToPixels(e,t,n=!0){let s=e.getTimeInPixels(t);return n&&(s+="px"),s},pixelsToTime(e,t,n=!0){n&&(t=t.slice(0,-2));let s=e.getPixelsInTime(t);return s},visualizeOscillator(e,t){const o=t.getCanvas(),s=o.getContext("2d"),r=o.width,i=o.height,a=1,c=4,l=Math.ceil(r/a);s.beginPath(),s.moveTo(0,.5*i);for(let e=0;e<l;e++){const t=e*a;s.lineTo(t,i*(.5+.5*Math.sin(1/c*t)))}s.stroke()},visualizeAutomation(e,t,n){t.canvasDrawable.visualize(n)},visualizeFullWaveform(e,t,n){const c=t.getCanvas(),s=c.getContext("2d");s.save();const r=c.width,_=c.height,l=.5*_;s.fillStyle=n.lighten(-30).toString(),s.strokeStyle=n.lighten(30).toString(),s.lineWidth=3;const d=PQ_DAW.AUDIO.getResource(t.getSource()),u=d.getChannelData(0),y=this.pixelsToTime(e,r,!1),g=t.getOffset(),j=d.duration,m=u.length/j,b=m*y,v=Math.floor(m*g),h=1,p=Math.ceil(b/(r*h));let f=[],i=[];for(let e=0;e<r;e+=h){var o=1,a=-1;const n=e*p+v;for(let e=0;e<p;e++){const s=n+e,t=u[s];o=Math.min(o,t),a=Math.max(a,t)}const t=(1+o)*l+1,s=t+Math.max(1,(a-o)*l);f.push({x:e,y:t}),i.push({x:e,y:s})}i.reverse(),s.beginPath(),s.moveTo(0,0);for(const e of f)s.lineTo(e.x,e.y);for(const e of i)s.lineTo(e.x,e.y);s.shadowColor="rgba(255,255,255,0.8)",s.shadowBlur=10,s.fill(),s.restore()}},PQ_DAW.Recorder=class{constructor(){this.chunks=[],this.startTime=0,this.endTime=0,this.mediaRecorder=null,this.blob=null,this.URI=null}async start(e=0){this.startTime=e,this.chunks=[];const t=await window.navigator.mediaDevices.getUserMedia({audio:!0,video:!1});this.mediaRecorder=new MediaRecorder(t);const n=this;this.mediaRecorder.ondataavailable=e=>{n.chunks.push(e.data)},this.mediaRecorder.start(10/60*1e3)}stop(e=0){this.endTime=e,this.mediaRecorder.stop(),this.blob=new Blob(this.chunks,{type:"audio/ogg; codecs=opus"}),this.URI=window.URL.createObjectURL(this.blob)}getState(){return this.mediaRecorder.state}async saveInBuffer(e){await PQ_DAW.AUDIO.saveBlobResource(e,this.URI,this.blob)}download(){var e=document.createElement("a");e.style.display="none",e.href=this.URI,e.download="Recording.ogg",document.body.appendChild(e),e.click()}getPartParams(){return{recalculate:!0,redraw:!0,dataset:{type:"blob",source:this.URI,start:this.startTime,end:this.endTime}}}},PQ_DAW.PLUGIN_LIST={},PQ_DAW.Plugin=class{constructor(e){this.track=e.parent,this.type=e.type,this.button=e.button,this.visible=!1,this.existingHTML=e.existingHTML,this.constant=!1,this.oldWetValue=null,this.existingHTML&&(this.node=this.existingHTML);const t=PQ_DAW.PLUGIN_LIST[this.type];if(this.plugin=new t(this),this.createEssentialHTML(),this.node.dataset.name=this.type,!this.existingHTML){const e=this.track.effectWindowsContainer;e.appendChild(this.node)}this.createEssentialNodes(),this.createCustomNodes(),this.createCustomHTML();const n=this.track.dataset.show.includes(this.type);n&&PQ_DAW.DOM.fakeClickButton(this.button)}setConstant(e){this.constant=e}setPlaying(e){if(typeof this.plugin.setPlaying!="function")return;this.plugin.setPlaying(e)}isConstant(){return this.constant}getDaw(){return this.track.daw}getContext(){return this.getDaw().getContext()}isVisible(){return this.visible}setVisible(e){this.visible=e,e?this.node.style.display="block":this.node.style.display="none",this.node.style.borderColor=PQ_DAW.DISPLAY.getColorForTrack(this.track).lighten(-30).toString()}createEssentialNodes(){const e=this.getContext(),t=e.createGain(),n=e.createGain();this.inputNode=t,this.outputNode=n,this.dryGain=new GainNode(e),this.wetGain=new GainNode(e),this.setWet(.5),t.connect(this.dryGain).connect(this.outputNode),t.connect(this.wetGain)}attachToFirstInput(e){this.wetGain.connect(e)}attachToFinalOutput(e){e.connect(this.outputNode)}createCustomNodes(){this.wetGain.disconnect(),this.plugin.createNodes()}createEssentialHTML(){const t=this.node;if(t)return;const e=document.createElement("div");e.classList.add("effect"),e.classList.add("effect-"+this.type),e.classList.add(this.type),e.dataset.type=this.type,e.style.display="none",this.node=e}createCustomHTML(){const t=this.generateDefaults(this.plugin.defaults);let e,n=this.existingHTML;n?(e=this.existingHTML.firstChild,e.innerHTML=""):(e=document.createElement("div"),e.classList.add("effect-container"),this.node.appendChild(e)),this.createHeaderHTML(e),this.plugin.createHTML(e,t)}createHeaderHTML(e){const t=document.createElement("div");t.classList.add("full-width","effect-header"),e.appendChild(t);const n=document.createElement("h2");n.innerHTML=this.type.toUpperCase(),t.appendChild(n);const s=document.createElement("p"),o="No description.";s.innerHTML=this.plugin.desc||o,t.appendChild(s);const i=PQ_DAW.DOM.getProperty(this.node,"bypass")=="true";PQ_DAW.DOM.createButton(this.node,{cont:t,value:i,name:"bypass",text:"Bypass",callback:this.onBypassToggle.bind(this)})}isBypassed(){return this.oldWetValue!=null}onBypassToggle(){const e=this.isBypassed();e?(this.setWet(this.oldWetValue),this.oldWetValue=null):(this.oldWetValue=this.getWetValue(),this.setWet(0)),this.isConstant()&&this.plugin.setPlaying(!this.isBypassed())}createDryWetControl(e,t=.5){PQ_DAW.DOM.createSlider(this.node,{cont:e,min:0,max:1,value:t,step:.01,name:"wet",text:"Dry/Wet",unit:"percentage",callback:e=>{this.setWet(e)}})}createMakeUpGainControl(e,t,n=0,s={min:-20,max:20}){const o=(s.max-s.min)/128;PQ_DAW.DOM.createSlider(this.node,{cont:e,min:s.min,max:s.max,value:n,step:o,name:"gain",text:"Gain",unit:"gain",audioParams:t})}setWet(e){var t=Math.cos(e*.5*Math.PI),n=Math.cos((1-e)*.5*Math.PI);this.dryGain.gain.value=t,this.wetGain.gain.value=n}getWetValue(){return this.wetGain.gain.value}getInputNode(){return this.inputNode}getOutputNode(){return this.outputNode}generateDefaults(e={}){const n=PQ_DAW.DOM,t=this.node;if(!t)return structuredClone(e);for(const o in e){let s=n.getProperty(t,o);if(!s)continue;let i=t.querySelectorAll("*[name='"+o+"']")[0].dataset.unit;i=="gain"&&(s=PQ_DAW.AUDIO.gainToDecibels(parseFloat(s))),e[o]=s}return e}remove(){this.button&&this.button.remove(),typeof this.plugin.remove=="function"&&this.plugin.remove(),this.node.remove()}},PQ_DAW.PLUGIN_LIST.compressor=class{constructor(e){this.plugin=e,this.audioNodes={},this.defaults={threshold:-3,knee:3,ratio:2,attack:.05,release:.05,gain:0},this.minGain=.001,this.maxGain=1,this.graphStyle="linear",this.prevVolumeDot={x:.5,y:.5},this.desc="To compress more, lower threshold and raise ratio. Won't change much if the source already has low dynamic range."}createNodes(){const t=this.plugin.getContext(),n=t.createDynamicsCompressor(),s=t.createGain(),e=t.createAnalyser();e.fftSize=1024,e.maxDecibels=PQ_DAW.AUDIO.gainToDecibels(this.maxGain),e.minDecibels=PQ_DAW.AUDIO.gainToDecibels(this.minGain),this.audioNodes={compressor:n,gain:s,analyser:e},this.plugin.setWet(1),this.plugin.attachToFirstInput(e),e.connect(n),n.connect(s),this.plugin.attachToFinalOutput(s)}createHTML(e,t){const n=PQ_DAW.DOM,o=this.audioNodes.compressor,a=this.audioNodes.gain,s=this.plugin.node,i=document.createElement("canvas");e.appendChild(i),this.canvas=i,n.createSlider(s,{cont:e,min:-50,max:0,value:t.threshold,step:.25,name:"threshold",text:"Threshold",unit:"decibels",audioParams:o.threshold}),n.createSlider(s,{cont:e,min:0,max:40,value:t.knee,step:.5,name:"knee",text:"Knee",unit:"decibels",audioParams:o.knee}),n.createSlider(s,{cont:e,min:1,max:20,value:t.ratio,step:.5,name:"ratio",text:"Ratio",unit:"ratio",audioParams:o.ratio}),n.createSlider(s,{cont:e,min:0,max:1,value:t.attack,step:.01,name:"attack",text:"Attack",unit:"time",audioParams:o.attack}),n.createSlider(s,{cont:e,min:0,max:1,value:t.release,step:.01,name:"release",text:"Release",unit:"time",audioParams:o.release}),n.createSlider(s,{cont:e,min:-4,max:10,value:t.gain,step:.25,name:"gain",text:"Gain",unit:"gain",audioParams:a.gain}),this.visualize()}visualize(){if(this.animFrame=requestAnimationFrame(this.visualize.bind(this)),!this.plugin.isVisible())return;this.canvas.width=this.canvas.parentElement.offsetWidth,this.canvas.height=.5*this.canvas.width;const e={widthScale:.66,heightScale:1,numGridLines:13,numCurvePoints:64,minGain:this.minGain,maxGain:this.maxGain,edgeMargin:20,fontSize:this.canvas.width/60,volumeDotRadius:10};e.actualWidth=this.canvas.width*e.widthScale-2*e.edgeMargin,e.actualHeight=this.canvas.height*e.heightScale-2*e.edgeMargin,e.oX=.5*(this.canvas.width-e.actualWidth),e.oY=.5*(this.canvas.height-e.actualHeight);const t=this.canvas.getContext("2d");t.fillStyle="#420742",t.fillRect(0,0,this.canvas.width,this.canvas.height),this.visualizeGrid(e);const n=this.visualizeCompressionCurve(e);this.visualizeVolume(e,n)}visualizeGrid(e){const i=e.actualWidth,o=e.actualHeight,n=e.oX,s=e.oY,t=this.canvas.getContext("2d"),a=e.numGridLines;t.strokeStyle="#FFFFFF",t.lineWidth=2,t.beginPath(),t.moveTo(n,s+o),t.lineTo(n+i,s+o),t.stroke(),t.beginPath(),t.moveTo(n+i,s),t.lineTo(n+i,s+o),t.stroke(),t.strokeStyle="rgba(255,255,255,0.25)",t.lineWidth=1,t.font=e.fontSize+"px Dosis",t.fillStyle="#FFFFFF";const r=e.minGain,l=e.maxGain,d=(l-r)/a,c=PQ_DAW.AUDIO.gainToDecibels(e.minGain),u=PQ_DAW.AUDIO.gainToDecibels(e.maxGain),h=(u-c)/a,m=i/a,f=o/a;for(let e=0;e<a;e++){const u=n+e*m,p=s+o-e*f;t.beginPath(),t.moveTo(n,p),t.lineTo(n+i,p),t.stroke(),t.beginPath(),t.moveTo(u,s),t.lineTo(u,s+o),t.stroke();let l;if(this.graphStyle=="log"){const t=r+e*d;l=PQ_DAW.AUDIO.gainToDecibels(t)}else this.graphStyle=="linear"&&(l=c+e*h);const g=15,v=e%2==0;if(v){let e=Math.ceil(l)+" dB";t.fillText(e,u,s+o+g)}const b=e%2==0;if(b){let e=Math.ceil(l)+" dB";t.fillText(e,n+i+.5*g,p)}}}visualizeCompressionCurve(e){const u=PQ_DAW.DOM.getProperty,r=this.plugin.node,o=this.canvas.getContext("2d"),O=e.numCurvePoints,a=1/O,f=e.actualWidth,y=e.actualHeight,c=e.oX,l=e.oY,d=f*a,i=y*a,h=PQ_DAW.AUDIO.gainToDecibels(e.minGain),j=PQ_DAW.AUDIO.gainToDecibels(e.maxGain),t=[],p=parseFloat(u(r,"threshold")),w=parseFloat(u(r,"knee")),v=parseFloat(u(r,"ratio")),_=p,b=p+w,g=PQ_DAW.AUDIO.decibelsToGain(p),m=Math.min(PQ_DAW.AUDIO.decibelsToGain(b),1);let n=0,s=y;for(;n<=f;){let e=n/f;if(this.graphStyle=="linear"){let t=h+(j-h)*e;e=PQ_DAW.AUDIO.decibelsToGain(t)}const o=e<g;if(o){n+=d,s-=i,t.push({x:c+n,y:l+s});continue}const r=e>=g&&e<m;if(r){let e=m-g;this.graphStyle=="linear"&&(e=(b-_)/(j-h));const o=Math.ceil(e/a),r=(v-1)/o;for(let e=0;e<=o;e++){let a=1+e*r;n+=d,s-=i*(1/a),t.push({x:c+n,y:l+s})}}const u=e>=m;if(u){n+=d,s-=i*(1/v),t.push({x:c+n,y:l+s});continue}}o.strokeStyle="pink",o.lineWidth=6,o.beginPath(),o.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)o.lineTo(t[e].x,t[e].y);return o.stroke(),t}visualizeVolume(e,t){const n=this.canvas.getContext("2d"),o=this.audioNodes.compressor.reduction,y=PQ_DAW.AUDIO.gainToDecibels(e.minGain),d=40,j=10,f=e.oX-d-j,h=PQ_DAW.AUDIO.gainToDecibels(e.minGain),b=PQ_DAW.AUDIO.gainToDecibels(e.maxGain),v=o/y,g=e.actualHeight*v;n.fillStyle="#33FF33",Math.abs(o)>=10?n.fillStyle="#FF3333":Math.abs(o)>=5&&(n.fillStyle="#AAAA33"),n.fillRect(e.oX+e.actualWidth+d,e.oY,f,g);const p=PQ_DAW.AUDIO.getVolumeAsGain(this.audioNodes.analyser),m=PQ_DAW.AUDIO.gainToDecibels(p);let l=PQ_DAW.AUDIO.decibelsToGain(m);this.graphStyle=="linear"&&(l=(m-h)/(b-h));const c=e.oX+l*e.actualWidth;let r=this.prevVolumeDot;if(c<=t[0].x)return;for(let e=1;e<t.length;e++)if(t[e-1].x<=c&&t[e].x>=c){r={x:.5*(t[e-1].x+t[e].x),y:.5*(t[e-1].y+t[e].y)};break}n.shadowBlur=10,n.shadowColor="#333333",n.fillStyle="pink";const a=this.canvas.height,i=this.canvas.width,u=.33,s={x:this.prevVolumeDot.x+u*(r.x/i-this.prevVolumeDot.x),y:this.prevVolumeDot.y+u*(r.y/a-this.prevVolumeDot.y)};console.log(s.x*i,s.y*a);const _=s.x*i,w=s.y*a;n.beginPath(),n.arc(_,w,e.volumeDotRadius,0,2*Math.PI),n.fill(),this.prevVolumeDot=s,n.shadowBlur=0}remove(){if(!this.animFrame)return;cancelAnimationFrame(this.animFrame)}},PQ_DAW.PLUGIN_LIST.delay=class{constructor(e){this.plugin=e,this.audioNodes={},this.defaults={wet:.5,feedback:.5,delayTime:.03,numRepetitions:0,pingPong:!1},this.desc="Lower feedback = softer repetitions. If repetitions zero, repeats continue until inaudible."}createNodes(){const t=this.plugin.node,n=PQ_DAW.DOM.getProperty;this.audioNodes={delay:[],gain:[],pan:[]};const e=this.plugin.getContext(),o=10,c=Math.min(n(t,"delayTime")||1,o),i=n(t,"feedback")||1,a=n(t,"numRepetitions")||0,l=a>0,s={delayTime:c,maxDelayTime:o};let d;const r=n(t,"pingPong")=="true"||!1;if(l){let t=this.plugin.wetGain,n=null,o=null;for(let l=0;l<a;l++){const r=new DelayNode(e,s);this.audioNodes.delay.push(r),l==0&&this.plugin.attachToFirstInput(r);const c=new GainNode(e,{gain:i});this.audioNodes.gain.push(c),o=c,l%2==0?(t.connect(r),r.connect(c),n=c):l%2==1&&(n.connect(r),r.connect(c),t=c)}if(r){const s=new ChannelMergerNode(e,{numberOfInputs:2});t.connect(s,0,0),n.connect(s,0,1),this.plugin.attachToFinalOutput(s)}else this.plugin.attachToFinalOutput(o)}else{const n=new DelayNode(e,s),o=new DelayNode(e,s);this.audioNodes.delay.push(n),this.audioNodes.delay.push(o);const t=new GainNode(e,{gain:i});if(this.audioNodes.gain.push(t),this.plugin.attachToFirstInput(t),r){const s=new ChannelMergerNode(e,{numberOfInputs:2});t.connect(n),o.connect(t),n.connect(o),n.connect(s,0,0),o.connect(s,0,1),this.plugin.attachToFinalOutput(s)}else t.connect(n),n.connect(t),this.plugin.attachToFinalOutput(t)}}createHTML(e,t){const n=this.plugin.node,s=PQ_DAW.DOM,o=e=>{const t=this.plugin.getContext().currentTime;for(const n of this.audioNodes.gain)n.gain.setValueAtTime(e,t,.03)},i=e=>{const t=this.plugin.getContext().currentTime;for(const n of this.audioNodes.delay)n.delayTime.setValueAtTime(e,t,.03)};this.plugin.createDryWetControl(e,t.wet),s.createSlider(n,{cont:e,min:0,max:1,value:t.feedback,step:.01,name:"feedback",text:"Feedback",unit:"percentage",callback:o}),s.createSlider(n,{cont:e,min:.03,max:4,value:t.delayTime,step:.01,name:"delayTime",text:"Delay",unit:"time",callback:i}),s.createSlider(n,{cont:e,min:0,max:10,value:t.numRepetitions,name:"numRepetitions",text:"Repetitions",unit:"none",callback:e=>{this.plugin.createCustomNodes()}}),s.createButton(n,{cont:e,value:t.pingPong,name:"pingPong",text:"Ping-Pong",callback:e=>{this.plugin.createCustomNodes()}})}},PQ_DAW.PLUGIN_LIST.distortion=class{constructor(e){this.plugin=e,this.audioNodes={},this.defaults={wet:.5,oversample:0,gain:0},this.desc="Distorts the signal. Usually way louder. Draw your own curve and listen to the results."}makeDistortionCurve(e=20){let t=256,n=new Float32Array(t);for(let s=0;s<t;++s){let o=s*2/t-1;n[s]=(Math.PI+e)*o/(Math.PI+e*Math.abs(o))}return n}createNodes(){const n=this.plugin.getContext(),e=n.createWaveShaper(),t=n.createGain();this.audioNodes={distortion:e,gain:t},e.curve=this.makeDistortionCurve(),this.plugin.attachToFirstInput(e),e.connect(t),this.plugin.attachToFinalOutput(t)}createHTML(e,t){const s=PQ_DAW.DOM,n=this.audioNodes.distortion,o=this.audioNodes.gain,i=this.plugin.node;this.plugin.createDryWetControl(e,t.wet),s.createSlider(i,{cont:e,min:0,max:4,value:t.oversample,step:2,name:"oversample",text:"Oversample",unit:"none",callback:e=>{e==0?n.oversample="none":n.oversample=e+"x"}}),this.plugin.createMakeUpGainControl(e,o.gain,t.gain)}},PQ_DAW.PLUGIN_LIST.equalizer=class{constructor(e){this.plugin=e,this.audioNodes={},this.canvas=null,this.bands={HighPass:{start:28,end:1e3,def:80,type:"highpass"},LowPass:{start:1e3,end:2e4,def:16e3,type:"lowpass"},LF:{start:20,end:200},LMF:{start:200,end:700},MF:{start:700,end:3e3},HMF:{start:3e3,end:7e3},HF:{start:7e3,end:2e4}};const t={gain:0};for(const s in this.bands){const e=s.toLowerCase(),n=this.bands[s],o=n.def||.5*(n.start+n.end);t[e+"frequency"]=o,t[e+"q"]=1,t[e+"gain"]=0}this.defaults=t,this.animFrame=null,this.desc="Higher Q = more narrow influence. Change gain on filters to use them (and see them in the graph)."}createNodes(){const t=this.plugin.getContext();let n=this.plugin.wetGain;this.plugin.setWet(1);for(const o in this.bands){const s=this.bands[o],i=s.def||.5*(s.start+s.end),e=t.createBiquadFilter();e.type=s.type||"peaking",e.frequency.value=i,e.gain.value=0,this.audioNodes[o]=e,n.connect(e),n=e}const s=t.createGain();this.audioNodes.gain=s,n.connect(s);const e=t.createAnalyser();e.fftSize=1024,e.maxDecibels=0,e.minDecibels=-128,this.audioNodes.analyser=e,s.connect(e),this.plugin.attachToFinalOutput(e)}getColorFromFrequency(e){const t=20,n=2e4,s=(Math.log2(e)-Math.log2(t))/Math.log2(n),o=Math.round(s*360);return"hsl("+o+", 50%, 50%)"}getFrequencyBins(e=64){const t=this.audioNodes.analyser.frequencyBinCount,s=t/e,n=[];for(let e=1;e<=t;e+=s)n.push(PQ_DAW.AUDIO.toLog(e,.5,t));return n}getFrequencies(e=64){const n=this.audioNodes.analyser.frequencyBinCount,s=this.plugin.getContext().sampleRate,o=.5*s,t=[];for(const s of this.getFrequencyBins(e))t.push(s*(o/n));return t}getLogarithmicFrequencyVolumes(e=64){const s=this.audioNodes.analyser.frequencyBinCount,t=new Uint8Array(s);this.audioNodes.analyser.getByteFrequencyData(t);const n=[];for(const s of this.getFrequencyBins(e)){const o=Math.floor(s),i=Math.ceil(s),a=t[o]/256,r=t[i]/256,c=(s-o)/(i-o),l=a+(r-a)*c;n.push(l)}return n}visualize(){if(this.animFrame=requestAnimationFrame(this.visualize.bind(this)),!this.plugin.isVisible())return;this.canvas.width=this.canvas.parentElement.offsetWidth,this.canvas.height=.5*this.canvas.width,this.visualConfig={centerLine:.6*this.canvas.height,numSteps:64,marginBetweenBars:2,totalBarWidth:100,filterResolution:4,dotRadius:this.canvas.width/60,fontSize:this.canvas.width/60,volumeRange:.5*(this.audioNodes.analyser.maxDecibels-this.audioNodes.analyser.minDecibels)};const e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#042e04",e.fillRect(0,0,this.canvas.width,this.canvas.height),this.visualizeGrid(),this.visualizeBars(),this.visualizeFilters()}visualizeGrid(){let t=10,n=12;const e=this.canvas.getContext("2d"),s=this.visualConfig.centerLine;e.strokeStyle="#FFCCAA",e.lineWidth=2,e.beginPath(),e.moveTo(0,s),e.lineTo(this.canvas.width,s),e.stroke();for(let s=0;s<t;s++){const o=this.canvas.width/t,i=s*o;for(let t=0;t<n;t++){e.lineWidth=t==0?2:1,e.strokeStyle=t==0?"rgba(255,255,255,0.5)":"rgba(255,255,255,0.2)";const s=i+t/n*o;e.beginPath(),e.moveTo(s,0),e.lineTo(s,this.canvas.height),e.stroke()}}}visualizeBars(){const o=this.visualConfig.numSteps,i=this.getLogarithmicFrequencyVolumes(o),t=this.getFrequencies(o),n=i.length,s=this.canvas.width/n;this.visualConfig.totalBarWidth=s;const a=s-this.visualConfig.marginBetweenBars,r=this.visualConfig.centerLine,c=this.canvas.height-this.visualConfig.centerLine;this.visualConfig.numOctaves=Math.log2(t[n-1])-Math.log2(t[0]),this.visualConfig.octaveInPixels=this.canvas.width/this.visualConfig.numOctaves,this.visualConfig.pixelsPerDecibelVolume=this.visualConfig.centerLine/this.visualConfig.volumeRange;const e=this.canvas.getContext("2d");for(let o=0;o<n;o++){const l=s*o,d=i[o]*r;e.fillStyle=this.getColorFromFrequency(t[o]),e.fillRect(l,this.canvas.height-c-d,a,d);const u=o%4==0;if(u){let n=t[o];n>=1e3?n=Math.round(n/1e3)+"kHz":n=Math.round(n)+"Hz",e.font=this.visualConfig.fontSize+"px Dosis",e.fillStyle="#FFFFFF",e.fillText(n,l,this.visualConfig.centerLine+24)}}}visualizeFilters(){const{summedCurves:e,dots:t}=this.getSummedFilterData(),n=this.convertSummedCurvesToLine(e);this.visualizeFilterLine(n),this.visualizeFilterDots(t)}getSummedFilterData(){const s=this.visualConfig.filterResolution*this.visualConfig.numSteps,e=this.getFrequencies(s),t=new Array(e.length).fill(null),n=[];for(const i in this.bands){const s=this.getFilterCurve(i,e);this.addToSummedCurve(t,s);const o=this.extractFilterDot(s);o&&n.push(o)}return{summedCurves:t,dots:n}}extractFilterDot(e){for(const t of e)if(t.dot)return t;return null}addToSummedCurve(e,t){const n=this.canvas.width/e.length;let s=-1;for(let a=0;a<t.length-1;a++){const o=t[a],i=t[a+1],c=Math.floor(o.x/n),l=Math.ceil(i.x/n),r=(l-c)*2;for(let a=0;a<r;a++){const c=Math.pow(Math.abs(i.x-o.x),.75),d={x:o.x+c,y:o.y},u={x:i.x-c,y:i.y},h=a/r,l=PQ_DAW.AUDIO.getBezierCurveTo(h,o,d,u,i),t=Math.round(l.x/n);if(t<=s)continue;if(t<0||t>=e.length)continue;e[t]==null&&(e[t]=0),e[t]+=l.y,s=t}}}getFilterCurve(e,t){const s=this.audioNodes[e],o=s.frequency.value,a=s.Q.value,n=[],r=Math.log2(o)-Math.log2(t[0]),i=r*this.visualConfig.octaveInPixels;if(s.type=="highpass"){const e=t[0],s=Math.log2(o)-Math.log2(e);n.push({x:0,y:-12*s}),n.push({x:i,y:0,dot:!0,freq:o})}if(s.type=="lowpass"){const e=t[t.length-1],s=Math.log2(e)-Math.log2(o);n.push({x:i,y:0,dot:!0,freq:o}),n.push({x:this.canvas.width,y:-12*s})}if(s.type=="peaking"&&Math.abs(s.gain.value)>=.03){const e=s.gain.value,t=i-this.visualConfig.octaveInPixels/a,r=i+this.visualConfig.octaveInPixels/a;n.push({x:t,y:0}),n.push({x:i,y:e,dot:!0,freq:o}),n.push({x:r,y:0})}return n}convertSummedCurvesToLine(e){const t=[],n=this.visualConfig.centerLine,s=this.canvas.width/e.length;for(let o=0;o<e.length;o++){const i=e[o];if(i==null)continue;const a=o*s,r=n-i*this.visualConfig.pixelsPerDecibelVolume;t.push({x:a,y:r})}return t}visualizeFilterLine(e){const t=this.canvas.getContext("2d");t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)t.lineTo(e[n].x,e[n].y);t.strokeStyle="#FFFFFF",t.lineWidth=5,t.stroke()}visualizeFilterDots(e){const t=this.canvas.getContext("2d");t.shadowBlur=10,t.shadowColor="#222222";for(const n of e){const s=n.x,o=this.visualConfig.centerLine-n.y*this.visualConfig.pixelsPerDecibelVolume;t.fillStyle=this.getColorFromFrequency(n.freq),t.beginPath(),t.arc(s,o,this.visualConfig.dotRadius,0,2*Math.PI),t.fill()}t.shadowBlur=0}createHTML(e,t){const n=PQ_DAW.DOM,s=this.plugin.node,i=document.createElement("canvas");e.appendChild(i),this.canvas=i;for(const a in this.bands){const c=a.toLowerCase(),r=this.bands[a],l=this.audioNodes[a],i=document.createElement("div");i.classList.add("effect-subsection"),e.appendChild(i);const d=document.createElement("div");d.classList.add("effect-subsection-header"),d.innerHTML=a,i.appendChild(d);let o=c+"frequency";n.createSlider(s,{cont:i,min:r.start,max:r.end,value:t[o],name:o,text:"Freq",unit:"hertz",audioParams:l.frequency}),o=c+"q",n.createSlider(s,{cont:i,min:.001,max:4,value:t[o],step:.01,name:o,text:"Q",unit:"dimensionless",audioParams:l.Q});const u=r.type=="lowpass"||r.type=="highpass";if(u)continue;o=c+"gain",n.createSlider(s,{cont:i,min:-20,max:20,value:t[o],step:.25,name:o,text:"Gain",unit:"decibels",audioParams:l.gain})}const o=document.createElement("div");o.classList.add("effect-subsection"),e.appendChild(o),this.plugin.createMakeUpGainControl(o,this.audioNodes.gain.gain,t.gain),this.visualize()}remove(){if(!this.animFrame)return;cancelAnimationFrame(this.animFrame)}},PQ_DAW.PLUGIN_LIST.reverb=class{constructor(e){this.plugin=e,this.audioNodes={},this.defaults={wet:.5,gain:0,duration:3,decay:2,reverse:!1,pregain:0,predelay:0},this.desc="Pick an impulse response. Or change the sliders to generate a dynamic impulse.",this.impulseResponses={None:"",Abernyte:"AbernyteGrainSilo","Living Room":"DomesticLivingRoom","Elveden Hall 1":"ElvedenHallLordsCloakroom","Elveden Hall 2":"ElvedenHallSmokingRoom",Brickworks:"ErrolBrickworksKiln","Royal Tennis Court":"FalklandPalaceRoyalTennisCourt","Inside Piano":"InsidePiano",Kinoull:"KinoullAisle","Maes Howe":"MaesHowe","Railroad Tunnel":"PurnodesRailroadTunnel","University Stairway":"StairwayUniversityOfYork","St Patricks Church":"StPatricksChurchPatringtonPosition3","Typing Room":"TerrysTypingRoom","Car Park":"UndergroundCarPark"}}onDynamicParametersChanged(){this.calculateAndUseDynamicImpulse()}async onImpulseSourceChanged(){const e=PQ_DAW.DOM.getProperty(this.plugin.node,"impulse");if(!e){this.calculateAndUseDynamicImpulse();return}const t=this.plugin.getDaw(),n={extension:"m4a",path:"/tutorials/daw/impulse_responses"};await PQ_DAW.AUDIO.checkAndLoadResources(t,[e],n),this.audioNodes.convolver.buffer=PQ_DAW.AUDIO.getResource(e)}calculateAndUseDynamicImpulse(){const e=PQ_DAW.DOM,t=this.plugin.node,n={duration:parseFloat(e.getProperty(t,"duration")),decay:parseFloat(e.getProperty(t,"decay")),reverse:e.getProperty(t,"reverse")=="true"},s=this.getDynamicImpulse(n);this.audioNodes.convolver.buffer=s}getDynamicImpulse(e){const s=this.plugin.getContext(),o=s.sampleRate,t=o*(e.duration||this.defaults.duration),i=e.decay||this.defaults.decay,a=e.reverse,n=s.createBuffer(2,t,o),r=n.getChannelData(0),c=n.getChannelData(1);for(let e=0;e<t;e++){const n=a?t-e:e;r[e]=(Math.random()*2-1)*Math.pow(1-n/t,i),c[e]=(Math.random()*2-1)*Math.pow(1-n/t,i)}return n}createNodes(){const e=this.plugin.getContext(),t=e.createConvolver(),n=e.createGain(),s=e.createChannelSplitter(2),o=e.createChannelMerger(2),i=e.createGain(),r=5,a=e.createDelay(r);this.plugin.attachToFirstInput(i),i.connect(a),a.connect(s),s.connect(t),t.connect(o),o.connect(n),this.plugin.attachToFinalOutput(n),this.audioNodes={splitter:s,merger:o,convolver:t,gain:n,preGain:i,preDelay:a}}createHTML(e,t){const n=this.plugin.node,s=PQ_DAW.DOM;this.plugin.createDryWetControl(e,t.wet),this.plugin.createMakeUpGainControl(e,this.audioNodes.gain.gain,t.gain),s.createSlider(n,{cont:e,min:-20,max:20,value:t.pregain,step:.1,name:"pregain",text:"Pre-Gain",unit:"gain",audioParams:this.audioNodes.preGain.gain}),s.createSlider(n,{cont:e,min:0,max:5,value:t.predelay,step:.05,name:"predelay",text:"Pre-Delay",unit:"time",audioParams:this.audioNodes.preDelay.delayTime}),s.createDropdown(n,{cont:e,keys:Object.keys(this.impulseResponses),values:Object.values(this.impulseResponses),name:"impulse",text:"Impulse",callback:this.onImpulseSourceChanged.bind(this)});const o=document.createElement("div");o.classList.add("effect-subsection"),e.appendChild(o),s.createSlider(n,{cont:o,min:.1,max:20,value:t.duration,step:.1,name:"duration",text:"Duration",unit:"time",callback:this.onDynamicParametersChanged.bind(this)}),s.createSlider(n,{cont:o,min:0,max:100,value:t.decay,step:.5,name:"decay",text:"Decay",unit:"none",callback:this.onDynamicParametersChanged.bind(this)}),s.createButton(n,{cont:o,value:t.reverse,name:"reverse",text:"Reverse",callback:this.onDynamicParametersChanged.bind(this)})}},PQ_DAW.PLUGIN_LIST.noise=class{constructor(e){this.plugin=e,this.audioNodes={},this.defaults={noise:"pink",gain:-25},this.noiseBuffers={white:null,pink:null,brown:null,blue:null,violet:null},this.needsNewNode=!1,this.playing=!1,this.plugin.setConstant(!0),this.desc="Pick one of the noise types. Very loud, constant sound."}setNoiseType(e){PQ_DAW.DOM.setProperty(this.plugin.node,"noise",e)}getNoiseType(){return PQ_DAW.DOM.getProperty(this.plugin.node,"noise")}convertToWhiteNoise(e,t){for(let n=0;n<t;n++)e[n]=Math.random()*2-1}convertToPinkNoise(e,t){var n,s,o,i,a,c,r=n=s=o=i=a=c=0;for(let d=0;d<t;d++){const l=Math.random()*2-1;r=.99886*r+l*.0555179,n=.99332*n+l*.0750759,s=.969*s+l*.153852,o=.8665*o+l*.3104856,i=.55*i+l*.5329522,a=-.7616*a-l*.016898;let u=r+n+s+o+i+a+c+l*.5362;c=l*.115926,u*=.11,e[d]=u}}convertToBrownNoise(e,t){let n=0;for(let s=0;s<t;s++){const i=Math.random()*2-1;let o=(n+.02*i)/1.02;n=o,o*=3.5,e[s]=o}}createNodes(){this.plugin.setWet(0);const t=this.plugin.getContext(),n=t.sampleRate,o=5,e=n*o;for(const t in this.noiseBuffers){if(t=="blue"||t=="violet")continue;const o=new AudioBuffer({length:e,sampleRate:n}),s=o.getChannelData(0);t=="white"?this.convertToWhiteNoise(s,e):t=="pink"?this.convertToPinkNoise(s,e):t=="brown"&&this.convertToBrownNoise(s,e),this.noiseBuffers[t]=o}this.noiseBuffers.blue=this.noiseBuffers.white,this.noiseBuffers.violet=this.noiseBuffers.white;const s=t.createGain();this.audioNodes.gain=s,this.plugin.attachToFinalOutput(s),this.needsNewNode=!0}onNoiseTypeChanged(){if(!this.playing)return;this.setPlaying(!1),this.setPlaying(!0)}createHTML(e,t){const n=[];for(const e in this.noiseBuffers)n.push(e+" noise");PQ_DAW.DOM.createDropdown(this.plugin.node,{cont:e,keys:n,values:Object.keys(this.noiseBuffers),name:"noise",text:"Type",callback:this.onNoiseTypeChanged.bind(this)}),this.plugin.createMakeUpGainControl(e,this.audioNodes.gain.gain,t.gain,{min:-50,max:0})}createNewNode(){const n=this.plugin.getContext(),e=this.getNoiseType(),t=new AudioBufferSourceNode(n,{buffer:this.noiseBuffers[e]});t.loop=!0,this.audioNodes.noise=t;const s=e=="blue"||e=="violet";if(s){const o=2e4;let s=.1;e=="violet"&&(s=1);const i=new BiquadFilterNode(n,{type:"bandpass",frequency:o,Q:s});t.connect(i).connect(this.audioNodes.gain)}else t.connect(this.audioNodes.gain);this.needsNewNode=!1}setPlaying(e){this.plugin.isBypassed()&&(e=!1),this.playing=e,e?(this.needsNewNode&&this.createNewNode(),this.audioNodes.noise.start()):(this.audioNodes.noise&&this.audioNodes.noise.stop(),this.needsNewNode=!0)}},PQ_DAW.PLUGIN_LIST.gain=class{constructor(e){this.plugin=e,this.audioNodes={},this.defaults={gain:0},this.desc="Just a node to change volume."}createNodes(){const t=this.plugin.getContext(),e=t.createGain();this.audioNodes={gain:e},this.plugin.attachToFirstInput(e),this.plugin.attachToFinalOutput(e)}createHTML(e,t){this.plugin.createMakeUpGainControl(e,this.audioNodes.gain.gain,t.gain)}}